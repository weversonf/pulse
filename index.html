<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mu Finance v03.08</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <style>
        :root {
            --bg-main: #121418;
            --bg-card: #1E2128;
            --accent-blue: #38bdf8;
            --danger: #fb7185;
            --warning: #eab308;
            --success: #34d399;
            --accent-orange: #f97316;
        }
        
        body { background-color: #000; font-family: 'Inter', sans-serif; color: white; margin: 0; display: flex; justify-content: center; height: 100vh; height: 100dvh; overflow: hidden; }
        .app-container { background-color: var(--bg-main); width: 100%; max-width: 450px; height: 100%; position: relative; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8); }

        @media (min-width: 768px) {
            body { justify-content: flex-start; background-color: #0b0d11; }
            .app-container { max-width: none; width: 100%; flex-direction: row; box-shadow: none; }
        }
        
        main { flex: 1; overflow-y: auto; padding-bottom: calc(130px + env(safe-area-inset-bottom)); scroll-behavior: smooth; }
        @media (min-width: 768px) { main { padding: 40px; } }
        
        .card { background-color: var(--bg-card); border: 1px solid rgba(255,255,255,0.05); }
        ::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .sensitive-value.blurred { filter: blur(10px); transition: filter 0.3s ease; }
        
        .overlay { position: absolute; bottom: -100%; left: 0; width: 100%; height: 92%; background-color: var(--bg-card); border-top-left-radius: 32px; border-top-right-radius: 32px; z-index: 100; transition: bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 -10px 40px rgba(0,0,0,0.8); border-top: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; }
        .overlay.active { bottom: 0; }
        .overlay-content { flex: 1; overflow-y: auto; padding: 0 24px 40px 24px; }
        .backdrop { position: absolute; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 90; display: none; }
        .backdrop.active { display: block; }

        .progress-ring__circle { transition: stroke-dashoffset 0.5s ease; transform: rotate(-90deg); transform-origin: 50% 50%; }

        nav { 
            position: absolute; bottom: 0; width: 100%; background-color: #16181D; 
            border-top-left-radius: 32px; border-top-right-radius: 32px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 5px 15px calc(15px + env(safe-area-inset-bottom)) 15px; 
            z-index: 80; box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
        }

        @media (min-width: 768px) {
            nav { position: relative; width: 260px; height: 100vh; flex-direction: column; justify-content: flex-start; align-items: stretch; border-radius: 0; padding: 30px 15px; border-right: 1px solid rgba(255,255,255,0.05); }
        }
        
        .nav-btn { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; color: #6b7280; border: none; background: none; cursor: pointer; flex: 1; transition: all 0.2s; padding-top: 15px; height: 100%; }
        .nav-btn.active { color: var(--accent-blue); }
        .nav-btn span { font-size: 10px; font-weight: 600; margin-top: 4px; }
        
        .active-indicator { position: absolute; top: 0; width: 22px; height: 3px; background-color: var(--accent-blue); border-radius: 4px; opacity: 0; transform: scaleX(0); transition: all 0.3s; }
        .nav-btn.active .active-indicator { opacity: 1; transform: scaleX(1); }

        .fab-wrapper { position: relative; display: flex; justify-content: center; width: 70px; margin-top: -35px; }
        .main-fab { background-color: var(--accent-blue); color: #000; width: 56px; height: 56px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 5px 20px rgba(56,189,248,0.4); z-index: 85; transition: transform 0.3s; cursor: pointer; border: none; }
        
        .day-circle { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; border: 1px solid #2d3139; color: #4b5563; font-weight: 700; cursor: pointer; }
        .day-circle.water-tracked { border-color: var(--accent-blue); color: var(--accent-blue); }
        .day-circle.goal-met { background-color: var(--accent-blue); color: #000; }
        
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div class="app-container">
        
        <div id="login-screen" class="absolute inset-0 bg-[#121418] z-[999] flex flex-col justify-center px-8">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold tracking-tight mb-2">Mu Finance</h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Personal Management v03.04</p>
            </div>
            <div class="space-y-4">
                <input type="email" id="login-email" class="bg-black/20 p-4 rounded-2xl border border-white/5 w-full outline-none" placeholder="E-mail">
                <input type="password" id="login-pwd" class="bg-black/20 p-4 rounded-2xl border border-white/5 w-full outline-none" placeholder="Senha">
                <p id="login-error" class="text-red-400 text-[10px] text-center font-bold h-4 uppercase"></p>
                <div class="flex space-x-2">
                    <button onclick="handleLogin()" class="flex-1 py-5 rounded-3xl bg-blue-500 text-black font-bold uppercase active:scale-95">Entrar</button>
                    <button onclick="handleRegister()" class="flex-1 py-5 rounded-3xl bg-black/20 text-white border border-white/5 font-bold uppercase active:scale-95">Criar</button>
                </div>
            </div>
        </div>

        <nav id="app-nav" class="hidden">
            <button onclick="navigate('nav-home', 'page-home', 'Visão Geral')" id="nav-home" class="nav-btn active">
                <div class="active-indicator"></div><i data-lucide="home"></i><span>Home</span>
            </button>
            <button onclick="navigate('nav-saude', 'page-saude', 'Saúde')" id="nav-saude" class="nav-btn">
                <div class="active-indicator"></div><i data-lucide="activity"></i><span>Saúde</span>
            </button>
            <div class="fab-wrapper"><button onclick="openTransactionModal('despesa')" class="main-fab"><i data-lucide="plus"></i></button></div>
            <button onclick="navigate('nav-financas', 'page-financas', 'Finanças')" id="nav-financas" class="nav-btn">
                <div class="active-indicator"></div><i data-lucide="dollar-sign"></i><span>Finanças</span>
            </button>
            <button onclick="navigate('nav-veiculo', 'page-veiculo', 'Veículo')" id="nav-veiculo" class="nav-btn">
                <div class="active-indicator"></div><i data-lucide="bike"></i><span>Veículo</span>
            </button>
        </nav>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header id="app-header" class="px-6 pt-10 pb-4 flex justify-between items-center shrink-0 hidden">
                <h1 id="header-title" class="text-2xl font-bold">Mu Finance</h1>
                <button onclick="toggleOverlay('perfil')" class="w-10 h-10 rounded-full bg-blue-500/20 border border-blue-500/50 flex items-center justify-center font-bold" id="header-initials">W</button>
            </header>

            <main id="main-scroll" class="px-6 hidden">
                <div id="page-home" class="page-content space-y-5 fade-in">
                    <div class="card rounded-3xl p-6 relative">
                        <span class="text-gray-500 text-[10px] uppercase font-bold">Saldo Geral</span>
                        <h2 class="text-4xl font-bold mt-2 sensitive-value fin-total-saldo" data-value="R$ 0,00">R$ 0,00</h2>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="card rounded-3xl p-5 text-center">
                            <span class="text-[8px] text-gray-500 uppercase font-bold block mb-2">Água Hoje</span>
                            <span class="text-xl font-black saude-agua-perc">0%</span>
                        </div>
                        <div class="card rounded-3xl p-5 text-center">
                            <span class="text-[8px] text-gray-500 uppercase font-bold block mb-2">Fazer 250</span>
                            <span class="text-sm font-bold" id="home-veh-media">29 km/l</span>
                        </div>
                    </div>

                    <div id="card-carousel" class="flex overflow-x-auto gap-4 pb-2 hide-scroll snap-x">
                        </div>
                </div>

                <div id="page-financas" class="page-content hidden space-y-5 fade-in">
                    <div id="recent-trans-list" class="space-y-3"></div>
                </div>

                <div id="page-veiculo" class="page-content hidden space-y-5 fade-in">
                    <div class="card p-6 rounded-3xl">
                        <h2 class="veh-name-text text-xl font-bold">Moto</h2>
                        <p class="text-xs text-gray-500">Total: <span id="veh-km-total">0</span> km</p>
                    </div>
                    <div id="veh-timeline" class="space-y-3"></div>
                </div>

                <div id="page-saude" class="page-content hidden space-y-5 fade-in">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="registrarSaude('escritorio')" class="card p-4 rounded-2xl text-xs font-bold">Escritório (+473ml)</button>
                        <button onclick="registrarSaude('casa')" class="card p-4 rounded-2xl text-xs font-bold">Em Casa (+350ml)</button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center text-[10px] pt-4">
                        </div>
                </div>
            </main>
        </div>

        <div id="backdrop" class="backdrop" onclick="closeAllOverlays()"></div>

        <div id="overlay-perfil" class="overlay">
            <div class="p-8">
                <h2 class="text-2xl font-bold mb-4">Perfil</h2>
                <button onclick="handleLogout()" class="w-full py-4 bg-red-500/10 text-red-500 rounded-2xl font-bold">Sair da Conta</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWlVvnA29CnKco7mBG6LvpzDtcYmr28cY",
            authDomain: "projetomu-d5722.firebaseapp.com",
            projectId: "projetomu-d5722",
            storageBucket: "projetomu-d5722.firebasestorage.app",
            messagingSenderId: "94478862714",
            appId: "1:94478862714:web:578561a199f685f9e5eec3"
        };

        const app = initializeApp(firebaseConfig);
        window.firebaseAuth = getAuth(app);
        window.firebaseDb = getFirestore(app);
        window.api = { signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, doc, setDoc, getDoc };
    </script>

    <script>
        let state = {
            userId: null, blurred: false,
            usuario: { firstName: "Weverson", lastName: "", contas: [{nome: 'Carteira', somaSaldo: true}] },
            saude: { aguaMeta: 3500, cafeinaMeta: 400, historico: {} },
            financas: { cartoes: [{id: 1, nome: 'Nubank', cor: '#8b5cf6', limite: 5400, bandeira: 'VISA', vencimento: 10}], transacoes: [] },
            veiculo: { tipo: 'moto', nome: 'Fazer 250', hodometro: 0, oleoIntervalo: 3000, oleoUltimaTrocaKM: 0, historico: [] }
        };

        function refreshIcons() { if(window.lucide) lucide.createIcons(); }

        async function loadDataFromCloud() {
            if(!state.userId) return;
            const docRef = window.api.doc(window.firebaseDb, "users", state.userId);
            try {
                const snap = await window.api.getDoc(docRef);
                if (snap.exists()) {
                    const data = snap.data();
                    state = { ...state, ...data };
                } else {
                    // Se não existe, cria o primeiro registro com os dados padrão
                    await window.api.setDoc(docRef, state);
                }
            } catch (e) { console.error(e); }
            updateUI();
        }

        async function saveDataToCloud() {
            if(!state.userId) return;
            const docRef = window.api.doc(window.firebaseDb, "users", state.userId);
            await window.api.setDoc(docRef, state);
        }

        function updateUI() {
            // Saldo
            let saldo = 0;
            state.financas.transacoes.forEach(t => {
                if(t.tipo === 'receita') saldo += t.valor;
                else saldo -= t.valor;
            });
            document.querySelectorAll('.fin-total-saldo').forEach(el => {
                const val = `R$ ${saldo.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
                el.innerText = val;
                el.setAttribute('data-value', val);
            });

            // Veículo
            document.getElementById('veh-km-total').innerText = state.veiculo.hodometro;
            document.querySelectorAll('.veh-name-text').forEach(el => el.innerText = state.veiculo.nome);

            // Cards
            renderCards();
            renderRecentTrans();
            renderVehTimeline();
            renderCalendar();
            refreshIcons();
        }

        function renderCards() {
            const container = document.getElementById('card-carousel');
            if(!container) return;
            container.innerHTML = state.financas.cartoes.map(c => `
                <div class="snap-center shrink-0 w-[280px] card rounded-3xl p-6 bg-gradient-to-br from-[#1E2128] to-[#121418]">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-xs font-bold text-gray-400">${c.nome}</span>
                        <i data-lucide="credit-card" style="color:${c.cor}"></i>
                    </div>
                    <span class="text-2xl font-bold">R$ ${c.limite.toLocaleString('pt-BR')}</span>
                    <p class="text-[10px] text-gray-500 uppercase mt-2">Limite Disponível</p>
                </div>
            `).join('');
        }

        function renderRecentTrans() {
            const list = document.getElementById('recent-trans-list');
            if(!list) return;
            list.innerHTML = state.financas.transacoes.slice(0, 5).map(t => `
                <div class="card p-4 rounded-2xl flex justify-between items-center">
                    <span class="text-sm font-bold">${t.cat}</span>
                    <span class="${t.tipo === 'receita' ? 'text-green-400' : 'text-red-400'} font-bold">R$ ${t.valor.toFixed(2)}</span>
                </div>
            `).join('');
        }

        function renderVehTimeline() {
            const list = document.getElementById('veh-timeline');
            if(!list) return;
            list.innerHTML = state.veiculo.historico.map(h => `
                <div class="card p-4 rounded-2xl text-xs font-bold uppercase">${h.tipo}: ${h.km} KM</div>
            `).join('');
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            if(!grid) return;
            grid.innerHTML = Array.from({length: 31}, (_, i) => `<div class="day-circle">${i+1}</div>`).join('');
        }

        function navigate(navId, pageId, title) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(navId).classList.add('active');
            document.getElementById('header-title').innerText = title;
        }

        function toggleOverlay(id) {
            document.getElementById('overlay-' + id).classList.add('active');
            document.getElementById('backdrop').classList.add('active');
        }

        function closeAllOverlays() {
            document.querySelectorAll('.overlay').forEach(o => o.classList.remove('active'));
            document.getElementById('backdrop').classList.remove('active');
        }

        // Funções de Registro
        function registrarSaude(t) {
            const hoje = new Date().toISOString().split('T')[0];
            if(!state.saude.historico[hoje]) state.saude.historico[hoje] = {agua:0};
            state.saude.historico[hoje].agua += (t === 'escritorio' ? 473 : 350);
            saveDataToCloud(); updateUI();
        }

        // Auth
        window.handleLogin = async () => {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-pwd').value;
            try { await window.api.signInWithEmailAndPassword(window.firebaseAuth, e, p); }
            catch (err) { document.getElementById('login-error').innerText = "Erro ao entrar"; }
        };

        window.handleRegister = async () => {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-pwd').value;
            try { await window.api.createUserWithEmailAndPassword(window.firebaseAuth, e, p); }
            catch (err) { document.getElementById('login-error').innerText = "Erro ao criar"; }
        };

        window.handleLogout = () => window.api.signOut(window.firebaseAuth);

        window.onload = () => {
            const check = () => {
                if(window.api && window.api.onAuthStateChanged) {
                    window.api.onAuthStateChanged(window.firebaseAuth, u => {
                        if(u) {
                            state.userId = u.uid;
                            document.getElementById('login-screen').classList.add('hidden');
                            document.getElementById('app-nav').classList.remove('hidden');
                            document.getElementById('app-header').classList.remove('hidden');
                            document.getElementById('main-scroll').classList.remove('hidden');
                            loadDataFromCloud();
                        } else {
                            document.getElementById('login-screen').classList.remove('hidden');
                            document.getElementById('app-nav').classList.add('hidden');
                        }
                    });
                } else setTimeout(check, 100);
            };
            check();
        };
    </script>
</body>
</html>
