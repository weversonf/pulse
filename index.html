<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse - v05</title>
    <!-- Tags para transformar em App no Android -->
    <meta name="theme-color" content="#020617">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Bibliotecas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap');

        :root {
            --sidebar-width: 16rem;
            --glass-bg: rgba(15, 23, 42, 0.8);
            --glass-border: rgba(255, 255, 255, 0.15);
            --ring-circumference: 339.292;
        }

        body { 
            font-family: 'Ubuntu', sans-serif; 
            background-color: #020617 !important;
            color: #f1f5f9;
            margin: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card, .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border) !important;
            border-radius: 2rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }

        .pulse-input { 
            background: rgba(15, 23, 42, 0.9) !important; 
            border: 1px solid var(--glass-border) !important; 
            border-radius: 0.75rem !important;
            padding: 0.85rem 1rem !important;
            color: white !important;
            outline: none !important;
            width: 100%;
            font-size: 12px;
        }

        .bottom-nav {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
        }

        .btn-interact { transition: all 0.2s ease; }
        .btn-interact:active { transform: scale(0.95); }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        /* Estilo Switch/Pill conforme imagem */
        .pill-control {
            display: flex;
            background: rgba(0,0,0,0.4);
            padding: 2px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.05);
            width: fit-content;
        }
        .pill-btn {
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #475569;
            white-space: nowrap;
        }
        .pill-btn.active {
            background: #fff;
            color: #020617;
            box-shadow: 0 4px 12px rgba(255,255,255,0.1);
        }
        .pill-btn.active.receita { background: #10b981; color: white; }
        .pill-btn.active.despesa { background: #ef4444; color: white; }
        .pill-btn.active.blue { background: #3b82f6; color: white; }

        /* Mobile Submenu UX */
        .mobile-submenu-overlay {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 1.5rem;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            z-index: 200;
            animation: slideUp 0.15s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translate(-50%, 10px); } to { opacity: 1; transform: translate(-50%, 0); } }
    </style>
</head>
<body class="bg-slate-950 pb-24 md:pb-0">

    <div id="app-root">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center animate-pulse">
                <h1 class="text-4xl font-bold text-blue-500 uppercase leading-none italic">Pulse - All in 1</h1>
                <p id="loading-text" class="text-[10px] uppercase tracking-widest text-slate-500 mt-4 italic">A ligar ao Firebase...</p>
            </div>
        </div>
    </div>

    <!-- Modais e Toasts -->
    <div id="global-modal" class="hidden fixed inset-0 bg-slate-950/95 backdrop-blur-xl flex items-center justify-center p-4 z-[200]"></div>
    <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[300] pointer-events-none space-y-2"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        let firebaseConfig = {
            apiKey: "AIzaSyAyqPiFoq6s7L6J3pPeCG-ib66H8mueoZs",
            authDomain: "pulse-68c1c.firebaseapp.com",
            projectId: "pulse-68c1c",
            storageBucket: "pulse-68c1c.firebasestorage.app",
            messagingSenderId: "360386380741",
            appId: "1:360386380741:web:d45af208f595b5799a81ac"
        };

        try { if (typeof __firebase_config !== 'undefined') { firebaseConfig = JSON.parse(__firebase_config); } } catch (e) {}

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pulse-os-personal-weverson';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwcsfpw1_uglhD6JtF4jAvjJ4hqgnHTcgKL8CBtb_i6pRmck7POOBvuqYykjIIE9sLdyQ/exec';

        const DEFAULT_DATA = {
            water_ml: 0,
            energy_mg: 0,
            perfil: { peso: 100, alcoholStart: "2026-02-09", alcoholTitle: "ZERO ÁLCOOL", alcoholTarget: 30, idade: 30 },
            veiculo: { km: 28450, oleo: 31000, montadora: "YAMAHA", modelo: "FAZER 250", consumo: 29 },
            categorias: ["Salário", "Veículo", "Moradia", "Saúde", "Lazer", "Alimentação", "Outros"],
            transacoes: [],
            tarefas: []
        };

        window.appState = {
            currentTab: 'dashboard',
            taskView: 'table', 
            extratoMonth: `${new Date().getFullYear()}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}`,
            categoryView: 'Despesa',
            categoryStatusFilter: 'Tudo', // Efetivado, Planejado, Tudo
            showBalance: true,
            showAllHistory: false,
            showMobileFinanceMenu: false,
            npsData: { score: '--', status: 'Sincronizando...', color: 'text-slate-500' },
            data: { ...DEFAULT_DATA }
        };

        window.modalState = { tipo: 'Despesa', status: 'Efetivada' };
        let pressTimer;

        // --- AUTH ---
        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, googleProvider); } catch (e) {} };
        window.logout = async () => { try { await signOut(auth); window.location.reload(); } catch (e) {} };

        // --- UTILITÁRIOS ---
        const format = (v) => (v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        const pushState = async () => { if (!auth.currentUser) return; try { await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'state', 'current'), window.appState.data); } catch (e) {} };
        
        const getFinanceStats = () => {
            const ts = window.appState.data.transacoes || [];
            const balEfetivado = ts.filter(t => t.status === 'Efetivada' || !t.status).reduce((a, b) => a + (b.tipo === 'Receita' ? (b.valor || 0) : -(b.valor || 0)), 0);
            const balProjetado = ts.reduce((a, b) => a + (b.tipo === 'Receita' ? (b.valor || 0) : -(b.valor || 0)), 0);
            return { balEfetivado, balProjetado };
        };

        const fetchNPS = async () => {
            try {
                const res = await fetch(SCRIPT_URL + `?t=${Date.now()}`, { redirect: 'follow' });
                const json = await res.json();
                const score = json.nps || 0;
                let color = 'text-emerald-500', status = 'Excelente';
                if (score < 70) { color = 'text-red-500'; status = 'Crítico'; }
                else if (score < 85) { color = 'text-orange-500'; status = 'Bom'; }
                window.appState.npsData = { score, status, color };
                render();
            } catch (e) {}
        };

        // --- INTERFACE ---
        window.openTab = (t) => { 
            window.appState.currentTab = t; 
            window.appState.showMobileFinanceMenu = false;
            render(); 
            if(['dashboard', 'financas'].includes(t)) fetchNPS(); 
            window.scrollTo(0,0);
        };

        window.handleNavPressStart = (id) => {
            if (id === 'financas') pressTimer = window.setTimeout(() => { window.appState.showMobileFinanceMenu = true; render(); if (navigator.vibrate) navigator.vibrate(50); }, 600);
        };
        window.handleNavPressEnd = () => clearTimeout(pressTimer);

        window.toggleFinanceView = (type) => { window.appState.categoryView = type; render(); };
        window.toggleFinanceStatus = (status) => { window.appState.categoryStatusFilter = status; render(); };

        window.initFinanceCharts = () => {
            const ctxLine = document.getElementById('financeChart');
            const ctxDonut = document.getElementById('categoryChart');
            if (!ctxLine) return;

            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const combinedData = months.map((_, i) => {
                const mStr = `2026-${(i + 1).toString().padStart(2, '0')}`;
                const ts = (window.appState.data.transacoes || []).filter(t => t.data?.startsWith(mStr));
                return ts.filter(t => t.tipo === 'Receita').reduce((a, b) => a + b.valor, 0) - ts.filter(t => t.tipo === 'Despesa').reduce((a, b) => a + b.valor, 0);
            });

            if (window.financeChartInstance) window.financeChartInstance.destroy();
            window.financeChartInstance = new Chart(ctxLine, {
                type: 'line',
                data: { labels: months, datasets: [{ data: combinedData, borderColor: '#3b82f6', borderWidth: 3, tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)', pointRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#475569', font: { size: 9, weight: 'bold' } } } } }
            });

            if (ctxDonut) {
                const currentM = window.appState.extratoMonth;
                const view = window.appState.categoryView;
                const filter = window.appState.categoryStatusFilter;

                const mTs = (window.appState.data.transacoes || []).filter(t => {
                    const monthMatch = t.data?.startsWith(currentM);
                    const typeMatch = t.tipo === view;
                    let statusMatch = true;
                    if (filter === 'Efetivado') statusMatch = (t.status === 'Efetivada' || !t.status);
                    else if (filter === 'Planejado') statusMatch = (t.status === 'Planejada');
                    return monthMatch && typeMatch && statusMatch;
                });

                const cats = {}; mTs.forEach(t => cats[t.cat] = (cats[t.cat] || 0) + t.valor);

                if (window.categoryChartInstance) window.categoryChartInstance.destroy();
                window.categoryChartInstance = new Chart(ctxDonut, {
                    type: 'doughnut',
                    data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#a855f7', '#6366f1'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } }
                });
            }
        };

        // --- COMPONENTES RENDER ---
        function renderSidebar() {
            const path = window.appState.currentTab;
            const menu = [{ id: 'dashboard', label: 'Home', icon: 'layout-dashboard' }, { id: 'saude', label: 'Saúde', icon: 'activity' }, { id: 'veiculo', label: 'Moto', icon: 'bike' }, { id: 'work', label: 'Tarefas', icon: 'briefcase' }, { id: 'financas', label: 'Finanças', icon: 'wallet', hasSub: true }];
            return `<aside class="hidden md:flex flex-col bg-slate-900 border-r border-white/5 fixed h-full z-50 w-64"><div class="p-8 flex items-center justify-between"><h1 class="text-xl font-bold text-blue-500 italic uppercase">Pulse</h1></div><nav class="flex-1 px-4 space-y-2">${menu.map(i => `<div><button onclick="window.openTab('${i.id}')" class="w-full flex items-center gap-4 p-4 rounded-2xl transition-all ${path === i.id ? 'bg-blue-500/10 text-blue-500' : 'text-slate-500 hover:bg-white/5'}"><i data-lucide="${i.icon}" class="w-5 h-5"></i><span class="text-xs font-bold uppercase tracking-widest">${i.label}</span></button>${i.hasSub ? `<div class="ml-12 mt-1 space-y-1"><button onclick="window.openTab('extrato')" class="w-full text-left py-2 text-[10px] font-bold uppercase tracking-widest ${path === 'extrato' ? 'text-blue-400' : 'text-slate-600 hover:text-slate-400'} transition-colors flex items-center gap-2"><i data-lucide="chevron-right" class="w-3 h-3"></i> Extrato</button></div>` : ''}</div>`).join('')}</nav><div class="p-4 border-t border-white/5"><button onclick="window.openTab('ajustes')" class="w-full flex items-center gap-4 p-4 rounded-2xl text-slate-500 hover:text-white"><i data-lucide="settings" class="w-5 h-5"></i><span class="text-xs font-bold uppercase tracking-widest">Ajustes</span></button></div></aside>`;
        }

        function renderBottomNav() {
            const path = window.appState.currentTab;
            const items = [{ id: 'dashboard', icon: 'layout-dashboard', label: 'Home' }, { id: 'saude', icon: 'activity', label: 'Saúde' }, { id: 'work', icon: 'briefcase', label: 'Work' }, { id: 'financas', icon: 'wallet', label: 'Grana' }];
            return `<div class="md:hidden fixed bottom-0 left-0 right-0 bottom-nav z-[100] flex justify-around p-2 pb-5">${window.appState.showMobileFinanceMenu ? `<div class="mobile-submenu-overlay"><button onclick="window.openTab('extrato')" class="flex gap-3 items-center px-6 py-4 rounded-2xl text-[10px] font-bold text-white bg-white/5 uppercase"><i data-lucide="clipboard-list" class="w-4 h-4"></i> Ver Extrato</button><button onclick="window.appState.showMobileFinanceMenu = false; render();" class="text-[8px] font-bold text-slate-700 py-2 uppercase">Fechar</button></div>` : ''}${items.map(i => `<button onclick="window.openTab('${i.id}')" onmousedown="window.handleNavPressStart('${i.id}')" onmouseup="window.handleNavPressEnd()" ontouchstart="window.handleNavPressStart('${i.id}')" ontouchend="window.handleNavPressEnd()" class="flex flex-col items-center gap-1 p-2 relative ${path === i.id || (i.id === 'financas' && path === 'extrato') ? 'text-blue-500' : 'text-slate-500'}"><i data-lucide="${i.icon}" class="w-6 h-6"></i><span class="text-[9px] font-bold uppercase">${i.label}</span>${i.id === 'financas' ? '<div class="absolute top-1 right-1 w-1 h-1 bg-blue-500 rounded-full animate-pulse"></div>' : ''}</button>`).join('')}</div>`;
        }

        function renderTabContent() {
            const t = window.appState.currentTab;
            const d = window.appState.data;
            const vis = window.appState.showBalance;
            const nps = window.appState.npsData;
            const header = `<div class="md:hidden flex justify-between items-center mb-8"><h1 class="text-2xl font-bold italic text-white uppercase leading-none">Pulse</h1><button onclick="window.openTab('ajustes')" class="p-3 bg-white/5 rounded-2xl text-slate-400"><i data-lucide="settings" class="w-5 h-5"></i></button></div>`;

            if (t === 'work') return `<h1 class="text-2xl text-center mt-20 text-slate-600">Módulo de Tarefas Sincronizando...</h1>`;
            if (t === 'extrato') return `${header}<h1 class="text-3xl font-bold italic uppercase mb-8">Histórico</h1><div class="space-y-3 mb-20">${(d.transacoes || []).sort((a,b)=>new Date(b.data)-new Date(a.data)).map(tx => `<div class="glass p-5 flex justify-between items-center border-l-4 ${tx.tipo==='Receita'?'border-emerald-500':'border-red-500'}"><div class="flex flex-col"><span class="text-[10px] font-bold text-white uppercase">${tx.desc}</span><span class="text-[8px] text-slate-600 uppercase mt-1">${tx.data.split('-').reverse().join('/')} • ${tx.cat}</span></div><span class="text-sm font-bold ${tx.tipo==='Receita'?'text-emerald-400':'text-red-400'}">R$ ${format(tx.valor)}</span></div>`).join('')}</div>`;

            switch(t) {
                case 'dashboard':
                    const statsD = getFinanceStats();
                    return `${header}<div class="mb-10"><p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 italic">Weverson OS</p><h1 class="text-5xl font-bold text-white uppercase italic tracking-tighter">Painel</h1></div><div class="grid grid-cols-1 md:grid-cols-3 gap-5"><div class="glass p-6 border-emerald-500/20 text-center"><p class="text-[9px] font-bold text-slate-500 uppercase mb-2">NPS Makro</p><h2 class="text-4xl font-bold ${nps.color} italic">${nps.score}%</h2></div><div class="glass p-6 border-blue-500/20 md:col-span-2"><p class="text-[9px] font-bold text-slate-500 uppercase mb-2 italic">Saldo Efetivado</p><h2 class="text-4xl font-bold text-white italic">R$ ${format(statsD.balEfetivado)}</h2></div></div>`;
                case 'saude': return `${header}<h1 class="text-4xl font-bold uppercase italic mb-8">Saúde</h1><div class="glass p-10 text-center text-slate-600 uppercase italic">Dados Biométricos Carregando...</div>`;
                case 'veiculo':
                    const v = d.veiculo;
                    return `${header}<h1 class="text-4xl font-bold uppercase italic mb-8">Moto</h1><div class="glass p-8 border-orange-500/20 mb-6"><div class="flex justify-between items-center mb-8"><div><h2 class="text-xl font-bold text-white italic">${v.montadora} ${v.modelo}</h2><p class="text-[9px] font-bold text-slate-500 uppercase mt-1">Plataforma Drivvo Sync</p></div><i data-lucide="bike" class="w-8 h-8 text-orange-500"></i></div><div class="grid grid-cols-2 gap-4"><div class="p-4 bg-white/5 rounded-2xl"><p class="text-[8px] font-bold text-slate-600 uppercase">Odômetro</p><h3 class="text-2xl font-bold text-white italic">${v.km} KM</h3></div><div class="p-4 bg-white/5 rounded-2xl"><p class="text-[8px] font-bold text-slate-600 uppercase">Consumo</p><h3 class="text-2xl font-bold text-emerald-400 italic">${v.consumo} KM/L</h3></div></div></div><div class="grid grid-cols-2 gap-4"><button onclick="window.openRefuelModal()" class="bg-orange-600/10 border border-orange-600/30 p-8 rounded-[2rem] flex flex-col items-center gap-3 active:scale-95 transition-all text-orange-500"><i data-lucide="fuel" class="w-6 h-6"></i><span class="text-[10px] font-bold uppercase tracking-widest">Abastecer</span></button><button onclick="window.openServiceModal()" class="bg-blue-600/10 border border-blue-600/30 p-8 rounded-[2rem] flex flex-col items-center gap-3 active:scale-95 transition-all text-blue-500"><i data-lucide="wrench" class="w-6 h-6"></i><span class="text-[10px] font-bold uppercase tracking-widest">Serviço</span></button></div>`;
                case 'financas':
                    const statsF = getFinanceStats();
                    return `${header}
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-4xl font-bold text-white uppercase italic leading-none">Finanças</h1>
                            <button onclick="window.openTransactionModal()" class="bg-emerald-600 text-white px-6 py-4 rounded-2xl font-bold uppercase text-[10px] shadow-lg"><i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> Lançar</button>
                        </div>
                        <div class="glass p-8 border-blue-500/30 mb-8">
                            <p class="text-[9px] font-bold uppercase text-blue-500 mb-2 italic">Saldo Efetivado</p>
                            <h2 class="text-4xl font-bold text-white italic">R$ ${format(statsF.balEfetivado)}</h2>
                            <p class="text-[8px] font-bold uppercase mt-4 text-slate-500">Previsão Acumulada: <span class="text-white">R$ ${format(statsF.balProjetado)}</span></p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="glass p-8 h-[350px] flex flex-col">
                                <h3 class="text-[10px] font-bold uppercase text-slate-500 mb-4 tracking-widest italic">Evolução do Saldo</h3>
                                <div class="flex-1 min-h-0"><canvas id="financeChart"></canvas></div>
                            </div>
                            <div class="glass p-8 h-[350px] flex flex-col">
                                <div class="flex flex-col gap-4 mb-4">
                                    <h3 class="text-[10px] font-bold uppercase text-slate-500 tracking-widest italic">Valor por Categoria</h3>
                                    <div class="flex flex-wrap gap-3">
                                        <!-- Botão Receita/Despesa -->
                                        <div class="pill-control">
                                            <button onclick="window.toggleFinanceView('Despesa')" class="pill-btn ${window.appState.categoryView==='Despesa'?'active despesa':''}">Despesa</button>
                                            <button onclick="window.toggleFinanceView('Receita')" class="pill-btn ${window.appState.categoryView==='Receita'?'active receita':''}">Receita</button>
                                        </div>
                                        <!-- Botão Status Filtro -->
                                        <div class="pill-control">
                                            <button onclick="window.toggleFinanceStatus('Efetivado')" class="pill-btn ${window.appState.categoryStatusFilter==='Efetivado'?'active blue':''}">Efetivado</button>
                                            <button onclick="window.toggleFinanceStatus('Planejado')" class="pill-btn ${window.appState.categoryStatusFilter==='Planejado'?'active blue':''}">Planejado</button>
                                            <button onclick="window.toggleFinanceStatus('Tudo')" class="pill-btn ${window.appState.categoryStatusFilter==='Tudo'?'active blue':''}">Tudo</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-1 min-h-0 relative"><canvas id="categoryChart"></canvas></div>
                            </div>
                        </div>`;
                case 'ajustes': return `${header}<h1 class="text-4xl font-bold uppercase italic mb-8">Ajustes</h1><div class="glass p-8 flex flex-col gap-6"><button onclick="window.logout()" class="w-full bg-red-500/10 text-red-500 py-5 rounded-2xl font-bold uppercase text-[10px] border border-red-500/20">Sair do Pulse</button></div>`;
                default: return '';
            }
        }

        const render = () => {
            const root = document.getElementById('app-root'); if (!root) return;
            if (!auth.currentUser) { root.innerHTML = `<div class="flex items-center justify-center min-h-screen"><button onclick="window.loginWithGoogle()" class="glass px-12 py-6 font-bold uppercase text-[10px] border-blue-500/30">Aceder ao Pulse OS</button></div>`; lucide.createIcons(); return; }
            root.innerHTML = `<div class="flex min-h-screen relative">${renderSidebar()}<div class="flex-1 md:ml-64 p-4 md:p-12 pb-32"><main class="max-w-6xl mx-auto">${renderTabContent()}</main></div>${renderBottomNav()}</div>`;
            lucide.createIcons(); if (window.appState.currentTab === 'financas') window.initFinanceCharts();
        };

        // --- HANDLERS MODAIS ---
        window.openTransactionModal = () => {
            const m = document.getElementById('global-modal');
            m.innerHTML = `<div class="bg-slate-900 border border-white/10 p-10 rounded-[2.5rem] w-full max-w-sm shadow-2xl"><h2 class="text-sm font-bold uppercase text-white mb-6 italic tracking-widest">Lançamento</h2><div class="space-y-4"><input type="text" id="f-desc" placeholder="DESCRIÇÃO" class="pulse-input uppercase"><input type="number" id="f-valor" placeholder="VALOR R$" class="pulse-input font-bold text-lg"><select id="f-cat" class="pulse-input uppercase">${window.appState.data.categorias.map(c=>`<option value="${c}">${c}</option>`).join('')}</select><input type="date" id="f-data" value="${new Date().toISOString().split('T')[0]}" class="pulse-input"><label class="flex items-center gap-3 p-4 bg-white/5 rounded-2xl cursor-pointer"><input type="checkbox" id="f-fixa" class="w-5 h-5 accent-blue-500"><span class="text-[10px] font-bold uppercase text-slate-400">Fixa (12 meses)</span></label></div><button onclick="window.saveTransaction()" class="w-full bg-emerald-600 text-white py-5 rounded-2xl font-bold uppercase text-[10px] mt-8 shadow-xl">Confirmar</button><button onclick="document.getElementById('global-modal').classList.add('hidden')" class="w-full text-slate-700 font-bold uppercase text-[8px] mt-4">Voltar</button></div>`;
            m.classList.remove('hidden'); lucide.createIcons();
        };

        window.saveTransaction = async () => {
            const v = parseFloat(document.getElementById('f-valor').value), d = document.getElementById('f-desc').value.toUpperCase(), c = document.getElementById('f-cat').value, dt = document.getElementById('f-data').value, f = document.getElementById('f-fixa').checked;
            if(isNaN(v) || !d) return;
            const count = f ? 12 : 1; const baseDate = new Date(dt + 'T12:00:00');
            for(let i=0; i<count; i++){
                const loopDate = new Date(baseDate); loopDate.setMonth(baseDate.getMonth() + i);
                window.appState.data.transacoes.push({ id: Date.now()+i, tipo: 'Despesa', status: 'Efetivada', desc: d + (f ? ` [${i+1}/12]`:''), valor: v, cat: c, data: loopDate.toISOString().split('T')[0] });
            }
            document.getElementById('global-modal').classList.add('hidden'); render(); await pushState();
        };

        window.openRefuelModal = () => {
            const m = document.getElementById('global-modal');
            m.innerHTML = `<div class="bg-slate-900 border border-orange-500/30 p-8 rounded-[2.5rem] w-full max-sm shadow-2xl"><h2 class="text-sm font-bold uppercase mb-6 flex items-center gap-2"><i data-lucide="fuel" class="w-4 h-4 text-orange-500"></i> Abastecer</h2><div class="space-y-4"><input type="number" id="v-km" placeholder="KM ATUAL" class="pulse-input text-xs font-bold"><input type="number" id="v-valor" placeholder="VALOR R$" class="pulse-input text-xs font-bold"><input type="date" id="v-data" value="${new Date().toISOString().split('T')[0]}" class="pulse-input text-xs"></div><button onclick="window.saveRefuel()" class="w-full bg-orange-600 text-white py-5 rounded-2xl font-bold uppercase text-[10px] mt-8">Salvar</button><button onclick="document.getElementById('global-modal').classList.add('hidden')" class="w-full text-slate-700 font-bold uppercase text-[8px] mt-4">Voltar</button></div>`;
            m.classList.remove('hidden'); lucide.createIcons();
        };

        window.saveRefuel = async () => {
            const km = parseFloat(document.getElementById('v-km').value), v = parseFloat(document.getElementById('v-valor').value);
            if(isNaN(v)) return; if(km > window.appState.data.veiculo.km) window.appState.data.veiculo.km = km;
            window.appState.data.transacoes.push({ id: Date.now(), tipo: 'Despesa', status: 'Efetivada', desc: `⛽ ABASTECIMENTO`, valor: v, cat: 'Veículo', data: document.getElementById('v-data').value });
            document.getElementById('global-modal').classList.add('hidden'); render(); await pushState();
        };

        onAuthStateChanged(auth, (u) => {
            if (u) {
                onSnapshot(doc(db, 'artifacts', appId, 'users', u.uid, 'state', 'current'), (s) => {
                    if (s.exists()) { window.appState.data = { ...DEFAULT_DATA, ...s.data() }; render(); } 
                    else { pushState(); render(); }
                    fetchNPS();
                });
            } else render();
        });

        window.addEventListener('resize', render);
    </script>
</body>
</html>
