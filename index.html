<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse v01.16</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-main: #121418;
            --bg-card: #1E2128;
            --accent-blue: #38bdf8;
            --text-muted: #8c92a0;
        }
        body {
            background-color: #000;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .app-container {
            background-color: var(--bg-main );
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        .card {
            background-color: var(--bg-card);
        }
        ::-webkit-scrollbar {
            display: none;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Estilos para a busca de usuários */
        #user-search-results { max-height: 150px; }
        #user-search-results button {
            transition: background-color 0.2s;
        }
        #user-search-results button:hover {
            background-color: #38bdf820;
        }
    </style>
</head>
<body class="flex justify-center h-screen w-full overflow-hidden text-white">

    <!-- ======================= NOVO: OVERLAY DE LOGIN ======================= -->
    <div id="login-overlay" class="absolute inset-0 bg-black/80 z-[100] flex-col items-center justify-center text-center p-8 backdrop-blur-sm hidden">
        <h1 class="text-3xl font-bold text-white mb-2">Bem-vindo ao Pulse</h1>
        <p class="text-gray-400 mb-8">Faça login para continuar e gerenciar sua vida.</p>
        <button id="btn-login-google" class="bg-white text-gray-800 font-semibold py-3 px-6 rounded-xl flex items-center justify-center space-x-3 hover:bg-gray-200 transition-colors">
            <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
            <span>Entrar com Google</span>
        </button>
    </div>

    <div class="app-container w-full max-w-md h-full relative flex flex-col">
        
        <!-- Header Fixo -->
        <header class="px-6 pt-10 pb-4 flex justify-between items-center shrink-0">
            <div>
                <h1 id="header-title" class="text-2xl font-bold tracking-tight transition-all">Visão Geral</h1>
                <p class="text-sm text-gray-400 mt-1">Fortaleza, CE</p>
            </div>
            <button id="btn-notificacoes" class="relative w-10 h-10 flex items-center justify-center rounded-full bg-[#1E2128] border border-gray-700 cursor-pointer hover:bg-gray-800 transition-colors shrink-0">
                <i data-lucide="bell" class="w-5 h-5 text-gray-300"></i>
                <span id="notificacao-ping" class="absolute top-[8px] right-[8px] w-2.5 h-2.5 bg-red-500 border-2 border-[#1E2128] rounded-full hidden"></span>
            </button>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto px-6 pb-28">
            
            <!-- PÁGINA 1: HOME -->
            <div id="page-home" class="page-content block space-y-5 fade-in">
                <!-- Conteúdo da Home Page -->
                <!-- ... (seu código original da home) ... -->
            </div>

            <!-- ... (outras páginas) ... -->

            <!-- PÁGINA 3: FINANÇAS -->
            <div id="page-financas" class="page-content hidden space-y-5 fade-in">
                <!-- ... (seu código original de finanças) ... -->
            </div>

            <!-- ... (outras páginas) ... -->

            <!-- Modal: Nova Transação Finanças -->
            <div id="modal-transacao-financas" class="absolute inset-0 bg-[#121418] z-[90] transform translate-y-full transition-transform duration-300 flex flex-col">
                <header class="px-6 pt-10 pb-4 flex justify-between items-center shrink-0 border-b border-gray-800 bg-[#1E2128]">
                    <button class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-700 transition-colors" onclick="fecharTransacaoFinancas()"><i data-lucide="arrow-left" class="w-5 h-5 text-gray-300"></i></button>
                    <h1 class="text-lg font-bold">Nova Transação</h1><div class="w-10 h-10"></div>
                </header>
                <main class="flex-1 overflow-y-auto p-6 space-y-6">
                    <div class="bg-gray-800 p-1 rounded-xl flex items-center w-full">
                        <button id="btn-tipo-despesa" class="flex-1 py-2 text-sm font-bold rounded-lg bg-red-400 text-[#121418] shadow-sm transition-all" onclick="setTipoTransacao('despesa')">Despesa</button>
                        <button id="btn-tipo-receita" class="flex-1 py-2 text-sm font-bold rounded-lg text-gray-400 hover:text-white transition-all" onclick="setTipoTransacao('receita')">Receita</button>
                    </div>
                    <div class="flex flex-col items-center justify-center py-4">
                        <span class="text-sm text-gray-400 mb-2">Valor da Transação</span>
                        <div class="flex items-center text-4xl font-bold">
                            <span id="transacao-moeda" class="text-gray-500 mr-2">R$</span>
                            <input type="number" placeholder="0,00" class="bg-transparent w-full text-center outline-none text-white placeholder-gray-600 w-48" id="input-valor-transacao">
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-sm text-gray-400 mb-1">Descrição</label>
                        <input type="text" id="transacao-desc" placeholder="Ex: Supermercado, Salário..." class="card p-4 rounded-2xl w-full outline-none text-white focus:ring-2 focus:ring-[#38bdf8] border border-transparent transition-all">
                    </div>

                    <!-- ======================= NOVO: CAMPO MARCAR USUÁRIO ======================= -->
                    <div class="flex flex-col relative">
                        <label class="text-sm text-gray-400 mb-1">Marcar Usuário (Opcional)</label>
                        <input type="text" id="transacao-marcar-usuario" placeholder="Digite para buscar, ex: @pry" class="card p-4 rounded-2xl w-full outline-none text-white focus:ring-2 focus:ring-[#38bdf8] border border-transparent transition-all">
                        <div id="user-search-results" class="absolute top-full mt-2 w-full card rounded-2xl border border-gray-700 overflow-y-auto z-10 hidden shadow-lg">
                            <!-- Resultados da busca serão inseridos aqui -->
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col">
                            <label class="text-sm text-gray-400 mb-1">Categoria</label>
                            <div class="relative">
                                <select id="transacao-categoria" class="card p-4 rounded-2xl w-full outline-none text-white focus:ring-2 focus:ring-[#38bdf8] border border-gray-700 transition-all appearance-none cursor-pointer"></select>
                                <i data-lucide="chevron-down" class="w-5 h-5 text-gray-500 absolute right-4 top-4 pointer-events-none"></i>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-sm text-gray-400 mb-1">Conta</label>
                            <div class="relative">
                                <select id="transacao-conta" class="card p-4 rounded-2xl w-full outline-none text-white focus:ring-2 focus:ring-[#38bdf8] border border-gray-700 transition-all appearance-none cursor-pointer"></select>
                                <i data-lucide="chevron-down" class="w-5 h-5 text-gray-500 absolute right-4 top-4 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between card p-4 rounded-2xl border border-gray-700">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-gray-400">
                                <i data-lucide="repeat" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <span class="block text-sm font-bold text-white">Transação Fixa</span>
                                <span class="block text-xs text-gray-500">Repetir por 12 meses</span>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer" id="toggle-fixa">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#38bdf8]"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between card p-4 rounded-2xl border border-gray-700">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-500">
                                <i data-lucide="check-circle" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <span class="block text-sm font-bold text-white">Status da Transação</span>
                                <span class="block text-xs text-gray-500" id="status-label">Efetivada (Paga/Recebida)</span>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer" id="toggle-efetivada" checked onchange="toggleStatusTransacao(this)">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                        </label>
                    </div>

                    <div class="flex flex-col">
                        <label class="text-sm text-gray-400 mb-1">Data</label>
                        <input type="date" value="2026-02-25" class="card p-4 rounded-2xl w-full outline-none text-white focus:ring-2 focus:ring-[#38bdf8] border border-transparent transition-all appearance-none" style="color-scheme: dark;">
                    </div>
                    <button id="btn-salvar-transacao" class="w-full bg-red-400 text-[#121418] font-bold text-lg py-4 rounded-2xl hover:brightness-110 transition-colors shadow-lg mt-6" onclick="salvarTransacaoFinancas()">
                        Lançar Despesa
                    </button>
                </main>
            </div>

            <!-- ... (resto dos seus modais) ... -->
        </main>

        <!-- ... (seu menu inferior) ... -->
    </div>

    <!-- ======================= NOVO: SCRIPTS FIREBASE E LÓGICA ======================= -->
    <script type="module">
        // Importações dos módulos Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

        // Suas credenciais do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCZbIVkAcv6UITkC8RHWV1JlK1ZDnLyR1I",
            authDomain: "mucuripe-finance.firebaseapp.com",
            projectId: "mucuripe-finance",
            storageBucket: "mucuripe-finance.appspot.com", // Corrigido para .appspot.com
            messagingSenderId: "524788134673",
            appId: "1:524788134673:web:6d82be6c4a8a625b3092b0"
        };

        // Inicializa Firebase e serviços
        const app = initializeApp(firebaseConfig );
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Variável global para o usuário logado
        let currentUser = null;

        // Elementos da DOM para autenticação
        const loginOverlay = document.getElementById('login-overlay');
        const btnLogin = document.getElementById('btn-login-google');

        // Função para fazer login com Google
        function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then((result) => {
                    console.log("Login bem-sucedido!");
                    handleUser(result.user);
                })
                .catch((error) => {
                    console.error("Erro no login:", error.message);
                    alert("Houve um erro ao tentar fazer login. Tente novamente.");
                });
        }

        // Função para criar/atualizar o usuário no Firestore
        async function handleUser(user) {
            if (!user) return;
            const userRef = doc(db, 'usuarios', user.uid);
            const userDoc = await getDoc(userRef);

            if (!userDoc.exists()) {
                // Se o usuário não existe, cria um novo documento
                const username = user.email.split('@')[0].replace(/[^a-zA-Z0-9]/g, '');
                try {
                    await setDoc(userRef, {
                        nome_display: user.displayName,
                        email: user.email,
                        foto_url: user.photoURL,
                        username: `@${username}`,
                        criado_em: serverTimestamp()
                    });
                    console.log("Novo usuário criado no Firestore!");
                } catch (e) {
                    console.error("Erro ao criar usuário no Firestore: ", e);
                }
            }
        }

        // Monitora o estado da autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuário está logado
                currentUser = user;
                loginOverlay.style.display = 'none';
                document.getElementById('header-title').innerText = `Olá, ${user.displayName.split(' ')[0]}`;
                console.log("Usuário autenticado:", user.uid);
            } else {
                // Usuário está deslogado
                currentUser = null;
                loginOverlay.style.display = 'flex';
                document.getElementById('header-title').innerText = 'Visão Geral';
            }
        });

        // Adiciona o evento de clique ao botão de login
        btnLogin.addEventListener('click', signInWithGoogle);
        
        // Expondo funções ao escopo global para que os `onclick` do HTML funcionem
        window.signInWithGoogle = signInWithGoogle;

        // ======================= LÓGICA PARA BUSCA DE USUÁRIOS =======================
        const userInput = document.getElementById('transacao-marcar-usuario');
        const resultsContainer = document.getElementById('user-search-results');
        let searchTimeout;

        userInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const queryText = userInput.value.trim();
            if (queryText.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }
            searchTimeout = setTimeout(() => {
                searchUsers(queryText);
            }, 300); // Debounce para evitar buscas a cada tecla
        });

        async function searchUsers(searchText) {
            if (!currentUser) return; // Não busca se não estiver logado
            
            resultsContainer.innerHTML = '<div class="p-4 text-center text-xs text-gray-400">Buscando...</div>';
            resultsContainer.classList.remove('hidden');

            const usersRef = collection(db, "usuarios");
            // A busca por substring não é nativa do Firestore, então buscamos por prefixo.
            // O ideal seria usar um serviço de busca como Algolia, mas para começar, isso funciona.
            const q = query(usersRef, where("username", ">=", searchText), where("username", "<=", searchText + '\uf8ff'));
            
            try {
                const querySnapshot = await getDocs(q);
                resultsContainer.innerHTML = ''; // Limpa resultados
                
                if (querySnapshot.empty) {
                    resultsContainer.innerHTML = '<div class="p-4 text-center text-xs text-gray-400">Nenhum usuário encontrado.</div>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    // Impede que o usuário se marque
                    if (doc.id === currentUser.uid) return;

                    const userElement = document.createElement('button');
                    userElement.className = 'w-full flex items-center space-x-3 p-3 text-left';
                    userElement.onclick = () => selectUser(userData);
                    
                    userElement.innerHTML = `
                        <img src="${userData.foto_url}" class="w-8 h-8 rounded-full">
                        <div>
                            <span class="block text-sm font-medium text-white">${userData.nome_display}</span>
                            <span class="block text-xs text-gray-500">${userData.username}</span>
                        </div>
                    `;
                    resultsContainer.appendChild(userElement);
                });

            } catch (error) {
                console.error("Erro ao buscar usuários: ", error);
                resultsContainer.innerHTML = '<div class="p-4 text-center text-xs text-red-400">Erro ao buscar.</div>';
            }
        }

        function selectUser(userData) {
            userInput.value = userData.username;
            resultsContainer.classList.add('hidden');
            console.log("Usuário selecionado:", userData);
        }
        
        // Fecha a busca se clicar fora
        document.addEventListener('click', function(event) {
            if (!userInput.contains(event.target) && !resultsContainer.contains(event.target)) {
                resultsContainer.classList.add('hidden');
            }
        });

    </script>

    <!-- Seu script original, agora dentro do módulo para ter acesso às funções -->
    <script type="module">
        // Coloquei seu script original aqui para que ele continue funcionando.
        // Algumas funções precisarão ser expostas globalmente se forem chamadas por `onclick`.
        
        lucide.createIcons();

        // ================= ESTADO GLOBAL =================
        let odometroAtual = 18450;
        // ... (resto do seu código JS original)
        
        // Exemplo de como expor uma função para o HTML
        window.navigate = function(clickedElement, pageId, pageTitle) {
            // ... (sua lógica de navegação)
        }
        // FAÇA ISSO PARA TODAS AS FUNÇÕES QUE SÃO CHAMADAS VIA `onclick="..."`
        // Ex: window.toggleFab = toggleFab; window.abrirTransacaoFinancas = abrirTransacaoFinancas; etc.
    </script>

</body>
</html>
