<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse - v06</title>
    <!-- Bibliotecas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap');

        :root {
            --sidebar-width: 16rem;
            --glass-bg: rgba(15, 23, 42, 0.8);
            --glass-border: rgba(255, 255, 255, 0.15); /* Bordas bem visíveis */
            --ring-circumference: 339.292; /* 2 * PI * 54 */
        }

        body { 
            font-family: 'Ubuntu', sans-serif; 
            background-color: #020617 !important;
            color: #f1f5f9;
            margin: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Estilo unificado para todos os cards */
        .glass-card, .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border) !important;
            border-radius: 2rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }

        .pulse-input { 
            background: rgba(15, 23, 42, 0.9) !important; 
            border: 1px solid var(--glass-border) !important; 
            border-radius: 0.75rem !important;
            padding: 0.85rem 1rem !important;
            color: white !important;
            outline: none !important;
            width: 100%;
        }

        .bottom-nav {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
        }

        .progress-ring__circle {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            stroke-dasharray: var(--ring-circumference);
            stroke-dashoffset: var(--ring-circumference);
            transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .kanban-col {
            min-width: 260px; /* Reduzi um pouco para caber melhor */
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 1.5rem;
            padding: 1.25rem;
            flex-shrink: 0; /* Impede que a coluna amasse */
        }

        .btn-interact { transition: all 0.2s ease; }
        .btn-interact:active { transform: scale(0.95); }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-950 pb-24 md:pb-0">

    <div id="app-root">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center animate-pulse">
                <h1 class="text-4xl font-bold text-blue-500 uppercase leading-none italic">Pulse - All in 1</h1>
                <p class="text-[10px] uppercase tracking-widest text-slate-500 mt-4 italic">Sincronizando Universo Weverson...</p>
            </div>
        </div>
    </div>

    <!-- Modais e Toasts -->
    <div id="global-modal" class="hidden fixed inset-0 bg-slate-950/95 backdrop-blur-xl flex items-center justify-center p-4 z-[200]"></div>
    <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[300] pointer-events-none space-y-2"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pulse-os-personal-weverson';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwcsfpw1_uglhD6JtF4jAvjJ4hqgnHTcgKL8CBtb_i6pRmck7POOBvuqYykjIIE9sLdyQ/exec';

        // Configurações padrão
        const DEFAULT_DATA = {
            water_ml: 0,
            energy_mg: 0,
            perfil: { peso: 100, alcoholStart: "2026-02-09", alcoholTitle: "ZERO ÁLCOOL", alcoholTarget: 30, idade: 30 },
            veiculo: { km: 28450, oleo: 31000, montadora: "YAMAHA", modelo: "FAZER 250", consumo: 29 },
            categorias: ["Salário", "Veículo", "Moradia", "Saúde", "Lazer", "Alimentação", "Outros"],
            transacoes: [],
            tarefas: []
        };

        window.appState = {
            currentTab: 'dashboard',
            taskView: 'table', 
            extratoMonth: '2026-02',
            showBalance: true,
            npsData: { score: '--', status: 'Iniciando...', color: 'text-slate-500' },
            data: { ...DEFAULT_DATA }
        };

        // --- UTILITÁRIOS ---
        const format = (v) => (v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        
        const getElapsedDays = (dateStr) => {
            if (!dateStr) return 0;
            const start = new Date(dateStr + 'T00:00:00');
            const now = new Date();
            const diff = Math.floor((now - start) / (1000 * 60 * 60 * 24));
            return Math.max(0, diff);
        };
        window.getElapsedDays = getElapsedDays;

        const getFinComp = () => {
            const ts = window.appState.data.transacoes || [];
            const now = new Date();
            const cm = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
            const pm = `${now.getFullYear()}-${now.getMonth().toString().padStart(2, '0')}`;
            const calc = (m) => ts.filter(t => t.data?.startsWith(m)).reduce((a, b) => a + (b.tipo === 'Receita' ? b.valor : -b.valor), 0);
            const cn = calc(cm), cp = calc(pm);
            if (cp === 0) return { pct: '0', trend: 'stable' };
            const diff = ((cn - cp) / Math.abs(cp)) * 100;
            return { pct: Math.abs(diff).toFixed(1), trend: diff > 0 ? 'up' : 'down' };
        };

        const fetchNPS = async () => {
            try {
                const res = await fetch(SCRIPT_URL + `?t=${Date.now()}`, { redirect: 'follow' });
                const json = await res.json();
                const score = json.nps || json.score || 0;
                let color = 'text-emerald-500', status = 'Excelente';
                if (score < 70) { color = 'text-red-500'; status = 'Crítico'; }
                else if (score < 85) { color = 'text-orange-500'; status = 'Bom'; }
                window.appState.npsData = { score, status, color };
                render();
            } catch (e) {
                window.appState.npsData = { score: '!', status: 'Offline', color: 'text-red-400' };
                render();
            }
        };

        const pushState = async () => {
            if (!auth.currentUser) return;
            try { await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'state', 'current'), window.appState.data); } catch (e) {}
        };

        // --- FUNÇÕES DE INTERFACE ---
        window.openTab = (t) => { 
            window.appState.currentTab = t; 
            render(); 
            if(['dashboard', 'work'].includes(t)) fetchNPS(); 
            window.scrollTo(0,0);
        };
        window.toggleBalancePrivacy = () => { window.appState.showBalance = !window.appState.showBalance; render(); };
        window.setTaskView = (v) => { window.appState.taskView = v; render(); };

        // --- GRÁFICOS ---
        window.initFinanceCharts = () => {
            const ctxLine = document.getElementById('financeChart');
            const ctxDonut = document.getElementById('categoryChart');
            if (!ctxLine) return;

            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const data = months.map((_, i) => {
                const mStr = `2026-${(i + 1).toString().padStart(2, '0')}`;
                const ts = (window.appState.data.transacoes || []).filter(t => t.data?.startsWith(mStr));
                return ts.filter(t => t.tipo === 'Receita').reduce((a, b) => a + b.valor, 0) - ts.filter(t => t.tipo === 'Despesa').reduce((a, b) => a + b.valor, 0);
            });

            if (window.financeChartInstance) window.financeChartInstance.destroy();
            window.financeChartInstance = new Chart(ctxLine, {
                type: 'line',
                data: { labels: months, datasets: [{ data, borderColor: '#3b82f6', borderWidth: 2, tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.05)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#475569', font: { size: 9 } } } } }
            });

            if (ctxDonut) {
                const currentM = window.appState.extratoMonth;
                const mTs = (window.appState.data.transacoes || []).filter(t => t.data?.startsWith(currentM));
                const cats = {};
                mTs.filter(t => t.tipo === 'Despesa').forEach(t => cats[t.cat] = (cats[t.cat] || 0) + t.valor);

                if (window.categoryChartInstance) window.categoryChartInstance.destroy();
                window.categoryChartInstance = new Chart(ctxDonut, {
                    type: 'doughnut',
                    data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#a855f7'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { display: false } } }
                });
            }
        };

        // --- RENDERIZADORES ---
        function renderSidebar() {
            const path = window.appState.currentTab;
            const menu = [
                { id: 'dashboard', label: 'Home', icon: 'layout-dashboard' },
                { id: 'saude', label: 'Saúde', icon: 'activity' },
                { id: 'veiculo', label: 'Moto', icon: 'bike' },
                { id: 'work', label: 'Tarefas', icon: 'briefcase' },
                { id: 'financas', label: 'Finanças', icon: 'wallet' }
            ];
            return `<aside class="hidden md:flex flex-col bg-slate-900 border-r border-white/5 fixed h-full z-50 w-64"><div class="p-8"><h1 class="text-xl font-bold text-blue-500 italic uppercase">Pulse</h1></div><nav class="flex-1 px-4 space-y-2">${menu.map(i => `<button onclick="window.openTab('${i.id}')" class="w-full flex items-center gap-4 p-4 rounded-2xl transition-all ${path === i.id || (i.id === 'financas' && path === 'extrato') ? 'bg-blue-500/10 text-blue-500' : 'text-slate-500 hover:bg-white/5'}"><i data-lucide="${i.icon}" class="w-5 h-5"></i><span class="text-xs font-bold uppercase tracking-widest">${i.label}</span></button>`).join('')}</nav><div class="p-4 border-t border-white/5"><button onclick="window.openTab('ajustes')" class="w-full flex items-center gap-4 p-4 rounded-2xl text-slate-500 hover:text-white"><i data-lucide="settings" class="w-5 h-5"></i><span class="text-xs font-bold uppercase tracking-widest">Ajustes</span></button></div></aside>`;
        }

        function renderBottomNav() {
            const path = window.appState.currentTab;
            const items = [
                { id: 'dashboard', icon: 'layout-dashboard', label: 'Home' },
                { id: 'saude', icon: 'activity', label: 'Saúde' },
                { id: 'veiculo', icon: 'bike', label: 'Moto' },
                { id: 'work', icon: 'briefcase', label: 'Work' },
                { id: 'financas', icon: 'wallet', label: 'Grana' }
            ];
            return `<div class="md:hidden fixed bottom-0 left-0 right-0 bottom-nav z-[100] flex justify-around p-2 pb-5">${items.map(i => `<button onclick="window.openTab('${i.id}')" class="flex flex-col items-center gap-1 p-2 ${path === i.id ? 'text-blue-500' : 'text-slate-500'}"><i data-lucide="${i.icon}" class="w-6 h-6"></i><span class="text-[9px] font-bold uppercase">${i.label}</span></button>`).join('')}</div>`;
        }

        function renderWork() {
            const d = window.appState.data;
            const view = window.appState.taskView;
            const tasks = d.tarefas || [];
            const nps = window.appState.npsData;

            let viewContent = '';
            if (view === 'table') {
                viewContent = `<div class="w-full overflow-x-auto glass border-white/10"><table class="w-full text-left text-[10px] uppercase font-bold tracking-widest min-w-[600px]"><thead class="text-slate-600 border-b border-white/10"><tr><th class="p-4">Atividade</th><th class="p-4">Tipo</th><th class="p-4">Solicitante</th><th class="p-4">Prazo</th><th class="p-4">Status</th></tr></thead><tbody class="text-white">${tasks.map(t => `<tr class="border-b border-white/10 hover:bg-white/5"><td class="p-4">${t.desc}</td><td class="p-4"><span class="px-2 py-1 bg-white/5 rounded-md">${t.tipo}</span></td><td class="p-4 text-slate-500">${t.solicitante || 'Eu'}</td><td class="p-4">${t.prazo?.split('-').reverse().join('/')}</td><td class="p-4"><span class="px-2 py-1 rounded-md ${t.status === 'Concluido' ? 'bg-emerald-500/20 text-emerald-500' : t.status === 'Bloqueado' ? 'bg-red-500/20 text-red-500' : 'bg-blue-500/20 text-blue-500'}">${t.status}</span></td></tr>`).join('')}</tbody></table></div>`;
            } else if (view === 'kanban') {
                const statuses = ['Pendente', 'Fazendo', 'Concluido', 'Bloqueado'];
                viewContent = `<div class="w-full overflow-x-auto pb-4"><div class="flex gap-4 w-max">${statuses.map(s => `
                    <div class="kanban-col">
                        <div class="flex justify-between items-center mb-4"><span class="text-[9px] font-bold uppercase tracking-widest text-slate-500">${s}</span><span class="bg-white/10 px-2 py-0.5 rounded text-[8px]">${tasks.filter(t => t.status === s).length}</span></div>
                        <div class="space-y-3">${tasks.filter(t => t.status === s).map(t => `<div class="glass p-4 border-white/10 shadow-xl"><p class="text-xs font-bold text-white mb-2 leading-tight">${t.desc}</p><div class="flex justify-between items-center"><span class="text-[8px] text-slate-500">${t.tipo}</span><span class="text-[8px] font-bold text-blue-500 uppercase">${t.prazo?.split('-')[2]}/${t.prazo?.split('-')[1]}</span></div></div>`).join('')}</div>
                    </div>`).join('')}</div></div>`;
            } else if (view === 'gantt') {
                viewContent = `<div class="w-full glass p-12 text-center text-slate-600 text-[10px] uppercase font-bold tracking-[0.3em] italic border-dashed border-white/20">Visualização Gantt • Cronograma Makro Engenharia...</div>`;
            }

            return `<div class="flex justify-between items-center mb-8"><div><h1 class="text-4xl font-bold text-white uppercase italic">Work Sync</h1><p class="text-[9px] font-bold text-slate-500 uppercase mt-2 italic">Board Makro & Monday</p></div><button onclick="window.openTaskModal()" class="bg-blue-600 p-4 rounded-2xl shadow-xl active:scale-95 transition-all"><i data-lucide="plus" class="w-5 h-5 text-white"></i></button></div>
                <div class="glass p-6 mb-8 border-emerald-500/30 flex items-center justify-between flex-wrap gap-4"><div><p class="text-[9px] text-slate-500 uppercase mb-1">Performance NPS Makro</p><h2 class="text-4xl font-bold ${nps.color} italic">${nps.score}%</h2></div>
                <div class="flex gap-2"><button onclick="window.setTaskView('table')" class="p-3 rounded-xl ${view === 'table' ? 'bg-blue-600 text-white' : 'bg-white/10 text-slate-500'}"><i data-lucide="list" class="w-4 h-4"></i></button><button onclick="window.setTaskView('kanban')" class="p-3 rounded-xl ${view === 'kanban' ? 'bg-blue-600 text-white' : 'bg-white/10 text-slate-500'}"><i data-lucide="columns" class="w-4 h-4"></i></button><button onclick="window.setTaskView('gantt')" class="p-3 rounded-xl ${view === 'gantt' ? 'bg-blue-600 text-white' : 'bg-white/10 text-slate-500'}"><i data-lucide="gantt-chart" class="w-4 h-4"></i></button></div></div>
                <div class="max-w-full min-w-0">${viewContent}</div>`;
        }

        function renderTabContent() {
            const t = window.appState.currentTab;
            const d = window.appState.data;
            const vis = window.appState.showBalance;
            const nps = window.appState.npsData;
            const circ = 339.292;

            const header = `<div class="md:hidden flex justify-between items-center mb-8"><h1 class="text-2xl font-bold italic text-white uppercase">Pulse</h1><button onclick="window.openTab('ajustes')" class="p-3 bg-white/5 rounded-2xl text-slate-400"><i data-lucide="settings" class="w-5 h-5"></i></button></div>`;

            if (t === 'work') return renderWork();

            switch(t) {
                case 'dashboard':
                    const sDays = getElapsedDays(d.perfil.alcoholStart);
                    const bal = (d.transacoes || []).reduce((a, b) => a + (b.tipo === 'Receita' ? b.valor : -b.valor), 0);
                    const comp = getFinComp();
                    return `${header}<div class="mb-10"><p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.4em] mb-2 italic leading-none">Weverson OS</p><h1 class="text-5xl font-bold text-white uppercase italic tracking-tighter leading-none">Painel</h1></div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                            <div class="glass p-6 border-emerald-500/20"><p class="text-[9px] font-bold text-slate-500 uppercase mb-4">NPS Makro</p><h2 class="text-4xl font-bold ${nps.color} italic">${nps.score}</h2><p class="text-[8px] font-bold uppercase text-slate-600 mt-2">${nps.status}</p></div>
                            <div class="glass p-6 border-purple-500/20"><p class="text-[9px] font-bold text-slate-500 uppercase mb-4">Propósito</p><h2 class="text-4xl font-bold text-white italic">${sDays} Dias</h2><p class="text-[8px] font-bold uppercase text-slate-600 mt-2">${d.perfil.alcoholTitle}</p></div>
                            <div class="glass p-6 border-blue-500/20 md:col-span-2"><div class="flex justify-between items-center mb-4"><p class="text-[9px] font-bold text-slate-500 uppercase">Saldo Líquido</p><button onclick="window.toggleBalancePrivacy()"><i data-lucide="${vis ? 'eye' : 'eye-off'}" class="w-4 h-4 text-slate-600"></i></button></div><h2 class="text-4xl font-bold text-white italic">${vis ? 'R$ ' + format(bal) : 'R$ ••••••'}</h2><p class="text-[8px] font-bold uppercase mt-3 ${comp.trend === 'up' ? 'text-emerald-500' : 'text-red-500'} italic flex items-center gap-1"><i data-lucide="${comp.trend === 'up' ? 'trending-up' : 'trending-down'}" class="w-2.5 h-2.5"></i> ${vis ? comp.pct + '%' : '••%'} vs Jan</p></div>
                        </div>`;
                case 'saude':
                    const sG = (d.perfil.peso || 100) * 35;
                    const wP = Math.min(100, (d.water_ml / sG) * 100);
                    const cafP = Math.min(100, (d.energy_mg / 400) * 100);
                    const elapsedDays = getElapsedDays(d.perfil.alcoholStart);
                    const propP = Math.min(100, (elapsedDays / (d.perfil.alcoholTarget || 30)) * 100);
                    
                    return `${header}<h1 class="text-4xl font-bold text-white uppercase italic mb-8">Saúde</h1>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Hidratação -->
                            <div class="glass p-8 flex flex-col justify-between">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-[10px] font-bold text-sky-500 uppercase tracking-widest">Hidratação (3.5L)</h3>
                                    <span class="text-xs font-bold text-white">${Math.round(wP)}%</span>
                                </div>
                                <div class="flex justify-around items-center">
                                    <div class="text-center">
                                        <h2 class="text-6xl font-bold text-white italic tracking-tighter">${d.water_ml}ml</h2>
                                        <p class="text-[9px] text-slate-600 uppercase mt-2">Faltam ${Math.max(0, sG - d.water_ml)}ml</p>
                                    </div>
                                    <div class="relative w-32 h-32">
                                        <svg viewBox="0 0 120 120">
                                            <circle class="text-slate-900" stroke-width="10" stroke="currentColor" fill="transparent" r="54" cx="60" cy="60"/>
                                            <circle class="progress-ring__circle text-sky-500" stroke-width="10" style="stroke-dashoffset: ${circ - (wP / 100) * circ};" stroke-linecap="round" stroke="currentColor" fill="transparent" r="54" cx="60" cy="60"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <div class="w-full bg-slate-950 h-2 rounded-full overflow-hidden border border-white/5">
                                        <div class="bg-sky-500 h-full transition-all duration-1000" style="width: ${wP}%"></div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 mt-8">
                                    <button onclick="window.updateAction('water', 473)" class="bg-sky-500/10 border border-sky-500/30 py-5 rounded-2xl text-sky-400 font-bold uppercase text-[10px]">Office (473ml)</button>
                                    <button onclick="window.updateAction('water', 250)" class="bg-indigo-500/10 border border-indigo-500/30 py-5 rounded-2xl text-indigo-400 font-bold uppercase text-[10px]">Copo (250ml)</button>
                                </div>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Cafeína -->
                                <div class="glass p-8 flex flex-col border-rose-500/10">
                                    <div class="flex justify-between items-center mb-4">
                                        <div>
                                            <p class="text-[9px] font-bold text-rose-500 uppercase tracking-widest">Cafeína (Limite 400mg)</p>
                                            <h2 class="text-4xl font-bold text-white italic mt-1">${d.energy_mg}mg</h2>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="window.updateAction('energy', 160)" class="p-3 bg-emerald-500/10 rounded-2xl text-emerald-500 border border-emerald-500/20"><i data-lucide="zap" class="w-4 h-4"></i></button>
                                            <button onclick="window.updateAction('energy', 80)" class="p-3 bg-orange-500/10 rounded-2xl text-orange-500 border border-orange-500/20"><i data-lucide="coffee" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                    <div class="w-full bg-slate-950 h-2 rounded-full overflow-hidden border border-white/5 mb-2">
                                        <div class="bg-rose-500 h-full transition-all duration-1000" style="width: ${cafP}%"></div>
                                    </div>
                                    <p class="text-[8px] text-right font-bold text-slate-600 uppercase tracking-widest">${Math.round(cafP)}% do limite</p>
                                </div>

                                <!-- Propósito -->
                                <div class="glass p-8 border-purple-500/10 flex flex-col">
                                    <div class="flex justify-between items-center mb-4">
                                        <div>
                                            <p class="text-[9px] font-bold text-purple-500 uppercase tracking-widest">Propósito: ${d.perfil.alcoholTitle}</p>
                                            <h2 class="text-4xl font-bold text-white italic mt-1">${elapsedDays} Dias</h2>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-[8px] font-bold text-slate-600 uppercase">Meta: ${d.perfil.alcoholTarget || 30} dias</p>
                                        </div>
                                    </div>
                                    <div class="w-full bg-slate-950 h-2 rounded-full overflow-hidden border border-white/5 mb-2">
                                        <div class="bg-purple-500 h-full transition-all duration-1000" style="width: ${propP}%"></div>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <p class="text-[8px] font-bold text-slate-600 uppercase tracking-widest">${Math.round(propP)}% Concluído</p>
                                        <p class="text-[8px] font-bold text-emerald-500 uppercase tracking-widest italic">Sincronizado</p>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                case 'veiculo':
                    const v = d.veiculo;
                    return `${header}<h1 class="text-4xl font-bold text-white uppercase italic mb-8">Veículo</h1><div class="glass p-8 border-orange-500/20 mb-6"><div class="flex justify-between items-center mb-8"><div><h2 class="text-xl font-bold text-white italic">${v.montadora} ${v.modelo}</h2><p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mt-1">Sincronização Ativa</p></div><i data-lucide="bike" class="w-8 h-8 text-orange-500"></i></div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-6"><div><p class="text-[8px] font-bold text-slate-600 uppercase mb-1">KM Atual</p><h3 class="text-2xl font-bold text-white italic">${v.km} KM</h3></div><div><p class="text-[8px] font-bold text-slate-600 uppercase mb-1">Óleo Vence em</p><h3 class="text-2xl font-bold text-sky-400 italic">${v.oleo} KM</h3></div><div class="col-span-2 md:col-span-1"><p class="text-[8px] font-bold text-slate-600 uppercase mb-1">Média Real</p><h3 class="text-2xl font-bold text-emerald-400 italic">${v.consumo} KM/L</h3></div></div></div>
                        <button onclick="window.showToast('Funcionalidade Fortaleza brevemente')" class="w-full bg-orange-600 p-4 rounded-3xl font-bold uppercase text-xs shadow-xl active:scale-95 transition-all">Registar Abastecimento</button>`;
                case 'financas':
                    const fRec = (d.transacoes || []).filter(t => t.tipo === 'Receita').reduce((a, b) => a + b.valor, 0);
                    const fDes = (d.transacoes || []).filter(t => t.tipo === 'Despesa').reduce((a, b) => a + b.valor, 0);
                    const fComp = getFinComp();
                    return `${header}<div class="flex justify-between items-center mb-8"><h1 class="text-4xl font-bold text-white uppercase italic">Finanças</h1><div class="flex gap-2"><button onclick="window.openTab('extrato')" class="bg-blue-500/20 text-blue-500 px-4 py-3 rounded-2xl font-bold uppercase text-[10px] border border-blue-500/20">Extrato</button><button onclick="window.openTransactionModal()" class="bg-emerald-600 text-white px-6 py-3 rounded-2xl font-bold uppercase text-[10px] shadow-lg"><i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> Lançar</button></div></div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-8">
                            <div class="glass p-8 border-blue-500/30"><div class="flex justify-between items-center mb-2"><p class="text-[9px] font-bold uppercase text-blue-500 tracking-widest leading-none">Saldo Atual</p><button onclick="window.toggleBalancePrivacy()"><i data-lucide="${vis ? 'eye' : 'eye-off'}" class="w-4 h-4 text-slate-600"></i></button></div><h2 class="text-4xl font-bold text-white italic">${vis ? 'R$ ' + format(fRec - fDes) : 'R$ ••••••'}</h2><p class="text-[8px] font-bold uppercase mt-4 ${fComp.trend === 'up' ? 'text-emerald-500' : 'text-red-500'} italic flex items-center gap-1"><i data-lucide="${fComp.trend === 'up' ? 'trending-up' : 'trending-down'}" class="w-3 h-3"></i> ${vis ? fComp.pct + '%' : '••%'} vs Jan</p></div>
                            <div class="glass p-6 border-emerald-500/20 flex flex-col justify-between"><p class="text-[9px] font-bold uppercase text-emerald-500 mb-2">Entradas</p><h3 class="text-2xl font-bold text-white italic">${vis ? 'R$ ' + format(fRec) : 'R$ •••'}</h3></div>
                            <div class="glass p-6 border-red-500/20 flex flex-col justify-between"><p class="text-[9px] font-bold uppercase text-red-500 mb-2">Saídas</p><h3 class="text-2xl font-bold text-white italic">${vis ? 'R$ ' + format(fDes) : 'R$ •••'}</h3></div>
                        </div><div class="glass p-8 h-[300px] border-white/10"><canvas id="financeChart"></canvas></div>`;
                case 'extrato':
                    const eTs = (d.transacoes || []).filter(t => t.data?.startsWith(window.appState.extratoMonth)).sort((a, b) => new Date(b.data) - new Date(a.data));
                    return `${header}<h1 class="text-3xl font-bold text-white uppercase italic mb-8">Histórico</h1><div class="space-y-3 mb-24">${eTs.map(t => `<div class="glass p-5 flex justify-between items-center border-l-4 ${t.tipo === 'Receita' ? 'border-emerald-500' : 'border-red-500'}"><div><p class="text-xs font-bold text-white uppercase">${t.desc}</p><p class="text-[8px] font-bold text-slate-600 uppercase mt-1 italic">${t.cat} • ${t.data.split('-').reverse().join('/')}</p></div><h3 class="text-lg font-bold ${t.tipo === 'Receita' ? 'text-emerald-400' : 'text-red-400'} italic">${vis ? 'R$ ' + format(t.valor) : 'R$ •••'}</h3></div>`).join('')}</div>`;
                case 'ajustes':
                    return `${header}<h1 class="text-4xl font-bold text-white uppercase italic mb-8">Ajustes Sync</h1><div class="space-y-6 pb-24">
                        <div class="glass p-6 border-blue-500/10"><h3 class="text-[10px] font-bold text-blue-500 uppercase mb-4 tracking-widest italic">1. Perfil</h3><div class="grid grid-cols-2 gap-4"><div><label class="text-[8px] font-bold text-slate-700 uppercase px-1">Peso (kg)</label><input type="number" value="${d.perfil.peso}" onchange="window.saveAdj('perfil', 'peso', this.value)" class="pulse-input text-xs"></div><div><label class="text-[8px] font-bold text-slate-700 uppercase px-1">Idade</label><input type="number" value="${d.perfil.idade}" onchange="window.saveAdj('perfil', 'idade', this.value)" class="pulse-input text-xs"></div></div></div>
                        <div class="glass p-6 border-orange-500/10"><h3 class="text-[10px] font-bold text-orange-500 uppercase mb-4 tracking-widest italic">2. Moto (Fazer 250)</h3><div class="grid grid-cols-2 gap-4"><div><label class="text-[8px] font-bold text-slate-700 uppercase px-1">KM Atual</label><input type="number" value="${d.veiculo.km}" onchange="window.saveAdj('veiculo', 'km', this.value)" class="pulse-input text-xs"></div><div><label class="text-[8px] font-bold text-slate-700 uppercase px-1">Meta Óleo (KM)</label><input type="number" value="${d.veiculo.oleo}" onchange="window.saveAdj('veiculo', 'oleo', this.value)" class="pulse-input text-xs"></div></div></div>
                        <div class="glass p-6 border-purple-500/10"><h3 class="text-[10px] font-bold text-purple-500 uppercase mb-4 tracking-widest italic">3. Propósito</h3><div class="space-y-4"><div><label class="text-[8px] font-bold text-slate-700 uppercase px-1">Título Desafio</label><input type="text" value="${d.perfil.alcoholTitle}" onchange="window.saveAdj('perfil', 'alcoholTitle', this.value)" class="pulse-input text-xs uppercase"></div><div><label class="text-[8px] font-bold text-slate-700 uppercase px-1">Data Início</label><input type="date" value="${d.perfil.alcoholStart}" onchange="window.saveAdj('perfil', 'alcoholStart', this.value)" class="pulse-input text-xs font-bold"></div></div></div></div>`;
                default: return '';
            }
        }

        const render = () => {
            const root = document.getElementById('app-root');
            if (!root) return;
            const side = renderSidebar();
            const bottom = renderBottomNav();
            // Adicionado min-w-0 para permitir que os filhos overflow-x-auto funcionem corretamente
            root.innerHTML = `<div class="flex min-h-screen relative">${side}<div class="flex-1 transition-all md:ml-64 min-w-0"><main class="max-w-6xl mx-auto p-4 md:p-12 lg:p-16 min-w-0">${renderTabContent()}</main></div>${bottom}</div>`;
            lucide.createIcons();
            if (window.appState.currentTab === 'financas') window.initFinanceCharts();
        };
        window.render = render;

        // --- HANDLERS ---
        window.updateAction = async (t, v) => { if(t==='water') window.appState.data.water_ml+=v; if(t==='energy') window.appState.data.energy_mg+=v; render(); await pushState(); };
        window.saveAdj = async (c, k, v) => { const n = parseFloat(v); window.appState.data[c][k] = isNaN(n) || v.includes('-') ? v : n; render(); await pushState(); window.showToast("Sincronizado!"); };
        window.openTransactionModal = () => {
            const m = document.getElementById('global-modal');
            m.innerHTML = `<div class="bg-slate-900 border border-white/10 p-8 rounded-[2rem] w-full max-w-sm shadow-2xl"><h2 class="text-sm font-bold uppercase text-white mb-6 italic tracking-widest">Lançamento</h2><div class="space-y-4"><select id="f-tipo" class="pulse-input text-xs uppercase"><option value="Despesa">Despesa</option><option value="Receita">Receita</option></select><input type="text" id="f-desc" placeholder="DESCRIÇÃO" class="pulse-input uppercase text-xs"><input type="number" id="f-valor" placeholder="VALOR R$" class="pulse-input text-xs font-bold"><select id="f-cat" class="pulse-input text-xs uppercase">${window.appState.data.categorias.map(c => `<option value="${c}">${c}</option>`).join('')}</select><input type="date" id="f-data" value="${new Date().toISOString().split('T')[0]}" class="pulse-input text-xs"></div><button onclick="window.saveTransaction()" class="w-full bg-emerald-600 text-white py-5 rounded-2xl font-bold uppercase text-[10px] mt-8 shadow-xl">Salvar</button><button onclick="document.getElementById('global-modal').classList.add('hidden')" class="w-full text-slate-700 font-bold uppercase text-[8px] mt-4">Fechar</button></div>`;
            m.classList.remove('hidden'); lucide.createIcons();
        };
        window.saveTransaction = async () => {
            const v = parseFloat(document.getElementById('f-valor').value);
            if(isNaN(v)) return window.showToast("Erro", "error");
            window.appState.data.transacoes.push({ id: Date.now(), tipo: document.getElementById('f-tipo').value, desc: document.getElementById('f-desc').value.toUpperCase(), valor: v, cat: document.getElementById('f-cat').value, data: document.getElementById('f-data').value });
            document.getElementById('global-modal').classList.add('hidden'); render(); await pushState(); window.showToast("Ok!");
        };
        window.openTaskModal = () => {
            const m = document.getElementById('global-modal');
            m.innerHTML = `<div class="bg-slate-900 border border-white/10 p-8 rounded-[2rem] w-full max-w-sm shadow-2xl"><h2 class="text-sm font-bold uppercase text-white mb-6 italic tracking-widest">Nova Tarefa</h2><div class="space-y-4"><input type="text" id="t-desc" placeholder="ATIVIDADE" class="pulse-input uppercase text-xs"><select id="t-tipo" class="pulse-input text-xs uppercase"><option value="Makro">Makro Engenharia</option><option value="Trabalho">Trabalho</option><option value="Pessoal">Pessoal</option><option value="Viagem">Viagem</option></select><input type="text" id="t-sol" placeholder="SOLICITANTE" class="pulse-input uppercase text-xs"><input type="date" id="t-prazo" value="${new Date().toISOString().split('T')[0]}" class="pulse-input text-xs"><select id="t-status" class="pulse-input text-xs uppercase"><option value="Pendente">Pendente</option><option value="Fazendo">Fazendo</option><option value="Concluido">Concluido</option><option value="Bloqueado">Bloqueado</option></select></div><button onclick="window.saveTask()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-bold uppercase text-[10px] mt-8 shadow-xl">Criar Board</button><button onclick="document.getElementById('global-modal').classList.add('hidden')" class="w-full text-slate-700 font-bold uppercase text-[8px] mt-4">Fechar</button></div>`;
            m.classList.remove('hidden'); lucide.createIcons();
        };
        window.saveTask = async () => {
            const d = document.getElementById('t-desc').value; if(!d) return;
            window.appState.data.tarefas.push({ id: Date.now(), desc: d.toUpperCase(), tipo: document.getElementById('t-tipo').value, solicitante: document.getElementById('t-sol').value.toUpperCase(), prazo: document.getElementById('t-prazo').value, status: document.getElementById('t-status').value });
            document.getElementById('global-modal').classList.add('hidden'); render(); await pushState();
        };
        window.resetHealth = async () => { window.appState.data.water_ml = 0; window.appState.data.energy_mg = 0; render(); await pushState(); };
        window.showToast = (m, t='success') => {
            const c = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `px-6 py-3 rounded-2xl font-bold uppercase text-[10px] tracking-widest border shadow-2xl ${t==='success'?'bg-emerald-950/90 border-emerald-500 text-emerald-400':'bg-red-950/90 border-red-500 text-red-400'}`;
            toast.innerHTML = m; c.appendChild(toast); setTimeout(()=>toast.remove(), 3000);
        };

        // --- AUTH & LISTENERS ---
        onAuthStateChanged(auth, (u) => {
            if (u) {
                onSnapshot(doc(db, 'artifacts', appId, 'users', u.uid, 'state', 'current'), (s) => {
                    if (s.exists()) { window.appState.data = { ...DEFAULT_DATA, ...s.data() }; render(); }
                    else { pushState(); render(); }
                    fetchNPS();
                });
            }
        });

        const initAuth = async () => { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); };
        initAuth();
        window.addEventListener('resize', render);
        render();
    </script>
</body>
</html>
