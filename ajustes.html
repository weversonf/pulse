<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PULSE OS - Ajustes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="css/style.css">
</head>

<body class="bg-slate-950 text-slate-100 italic">

<div class="flex min-h-screen relative">
    <!-- Menu Lateral Dinâmico -->
    <div id="sidebar-placeholder"></div>

    <div id="main-content" class="flex-1 md:ml-64 transition-all duration-300 pb-safe-bottom">
        <!-- Cabeçalho Dinâmico -->
        <div id="header-placeholder"></div>

        <main class="max-w-6xl mx-auto p-4 md:p-8 space-y-8 italic">

            <!-- 1. IDENTIDADE CENTRAL -->
            <section class="space-y-4 animate-fade-in relative">
                <div class="glass-card p-6 flex items-center gap-6 shadow-xl shadow-blue-950/10">
                    <div class="relative group cursor-pointer" onclick="toggleAvatarSelector()">
                        <div id="avatar-preview-container" class="w-20 h-20 rounded-full bg-slate-950 border border-white/10 flex items-center justify-center overflow-hidden transition-all duration-500 group-hover:border-blue-500/50">
                            <i id="avatar-preview-icon" data-lucide="user" class="w-10 h-10 text-blue-500/50"></i>
                            <div class="absolute inset-0 bg-blue-600/20 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity rounded-full">
                                <i data-lucide="pencil" class="w-5 h-5 text-white"></i>
                            </div>
                        </div>
                        <div class="absolute bottom-1 right-1 w-5 h-5 bg-emerald-500 border-4 border-slate-950 rounded-full shadow-lg"></div>
                    </div>

                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="shield-check" class="w-3 h-3 text-blue-500"></i>
                            <span class="text-[8px] font-black text-blue-500 uppercase tracking-widest italic">Operador Identificado</span>
                        </div>
                        <h2 class="text-3xl font-black text-white uppercase tracking-tighter leading-none italic" id="set-user-name">CARREGANDO...</h2>
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-[0.4em] mt-3 italic">PULSE CENTRAL INTELLIGENCE</p>
                    </div>
                </div>

                <!-- Modal de Avatar (Lightbox) -->
                <div id="avatar-selector-wrapper" class="hidden fixed inset-0 z-[100] bg-slate-950/90 backdrop-blur-xl flex items-center justify-center p-4">
                    <div class="glass-card p-8 w-full max-w-2xl space-y-6 border-blue-500/30 shadow-2xl relative">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-black text-white italic uppercase">Escolher Identidade</h3>
                            <button onclick="toggleAvatarSelector()" class="text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 py-4">
                            <button onclick="selectAvatar('blue', 'user')" class="group p-4 rounded-2xl border border-white/5 hover:border-blue-500/50 transition-all text-center">
                                <i data-lucide="user" class="w-8 h-8 mx-auto text-blue-500 mb-2"></i>
                                <p class="text-[8px] font-black uppercase text-slate-500 group-hover:text-blue-500 italic">Classic</p>
                            </button>
                            <button onclick="selectAvatar('orange', 'bike')" class="group p-4 rounded-2xl border border-white/5 hover:border-orange-500/50 transition-all text-center">
                                <i data-lucide="bike" class="w-8 h-8 mx-auto text-orange-500 mb-2"></i>
                                <p class="text-[8px] font-black uppercase text-slate-500 group-hover:text-orange-500 italic">Rider</p>
                            </button>
                            <button onclick="selectAvatar('emerald', 'zap')" class="group p-4 rounded-2xl border border-white/5 hover:border-emerald-500/50 transition-all text-center">
                                <i data-lucide="zap" class="w-8 h-8 mx-auto text-emerald-500 mb-2"></i>
                                <p class="text-[8px] font-black uppercase text-slate-500 group-hover:text-emerald-500 italic">Tech</p>
                            </button>
                            <button onclick="selectAvatar('rose', 'heart')" class="group p-4 rounded-2xl border border-white/5 hover:border-rose-500/50 transition-all text-center">
                                <i data-lucide="heart" class="w-8 h-8 mx-auto text-rose-500 mb-2"></i>
                                <p class="text-[8px] font-black uppercase text-slate-500 group-hover:text-rose-500 italic">Bio</p>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. BIO-PERFIL (SAÚDE) -->
            <section class="space-y-4">
                <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-rose-500 px-2 flex items-center gap-2 italic">
                    <i data-lucide="activity" class="w-3 h-3"></i> Bio-Métricas (Saúde)
                </h3>
                <div class="glass-card p-6 grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="space-y-1">
                        <label class="text-[8px] font-black text-slate-500 uppercase px-2 italic">Peso (kg)</label>
                        <input type="number" id="set-peso" onchange="window.savePulseSettings()" class="pulse-input" placeholder="0">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[8px] font-black text-slate-500 uppercase px-2 italic">Altura (cm)</label>
                        <input type="number" id="set-altura" onchange="window.savePulseSettings()" class="pulse-input" placeholder="0">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[8px] font-black text-slate-500 uppercase px-2 italic">Idade</label>
                        <input type="number" id="set-idade" onchange="window.savePulseSettings()" class="pulse-input" placeholder="0">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[8px] font-black text-slate-500 uppercase px-2 italic">Sexo</label>
                        <select id="set-sexo" onchange="window.savePulseSettings()" class="pulse-input uppercase">
                            <option value="M">Masculino</option>
                            <option value="F">Feminino</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- 3. MÁQUINA (VEÍCULO) -->
            <section class="space-y-4">
                <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-orange-500 px-2 flex items-center gap-2 italic">
                    <i data-lucide="settings" class="w-3 h-3"></i> Parâmetros da Máquina
                </h3>
                <div class="glass-card p-6 space-y-6">
                    <div class="grid md:grid-cols-3 gap-4">
                        <select id="set-bike-tipo" onchange="window.updateBrands(); window.savePulseSettings();" class="pulse-input uppercase">
                            <option value="Moto">Moto</option>
                            <option value="Carro">Carro</option>
                        </select>
                        <select id="set-bike-montadora" onchange="window.updateModels(); window.savePulseSettings();" class="pulse-input uppercase"></select>
                        <select id="set-bike-modelo" onchange="window.updateConsumoDefault(); window.savePulseSettings();" class="pulse-input uppercase"></select>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4 pt-4 border-t border-white/5">
                        <div class="space-y-1">
                            <label class="text-[8px] font-black text-slate-500 uppercase px-2 italic">KM Atual</label>
                            <input type="number" id="set-bike-km" onchange="window.savePulseSettings()" class="pulse-input" placeholder="0">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[8px] font-black text-slate-500 uppercase px-2 italic">Troca Óleo (KM)</label>
                            <input type="number" id="set-bike-oleo" onchange="window.savePulseSettings()" class="pulse-input text-orange-400" placeholder="0">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[8px] font-black text-slate-500 uppercase px-2 italic">Consumo (KM/L)</label>
                            <input type="number" id="set-bike-consumo" onchange="window.savePulseSettings()" class="pulse-input text-emerald-400" placeholder="0">
                        </div>
                    </div>
                </div>
            </section>

            <!-- 4. CAFEÍNA E LOCALIZAÇÃO -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <section class="space-y-4">
                    <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-emerald-500 px-2 flex items-center gap-2 italic">
                        <i data-lucide="zap" class="w-3 h-3"></i> Calibragem Cafeína
                    </h3>
                    <div class="glass-card p-6 grid grid-cols-2 gap-4">
                        <input type="number" id="set-calib-monster" onchange="window.savePulseSettings()" class="pulse-input" placeholder="Monster mg">
                        <input type="number" id="set-calib-ml" oninput="window.autoCalcCaffeine()" onchange="window.savePulseSettings()" class="pulse-input" placeholder="Caneca ml">
                    </div>
                </section>

                <section class="space-y-4">
                    <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-blue-500 px-2 flex items-center gap-2 italic">
                        <i data-lucide="globe" class="w-3 h-3"></i> Regional
                    </h3>
                    <div class="glass-card p-6 grid grid-cols-2 gap-4">
                        <select id="set-estado" onchange="window.savePulseSettings()" class="pulse-input uppercase">
                            <option value="CE">Ceará</option>
                            <option value="SP">São Paulo</option>
                        </select>
                        <select id="set-cidade" onchange="window.savePulseSettings()" class="pulse-input uppercase">
                            <option value="Fortaleza">Fortaleza</option>
                        </select>
                    </div>
                </section>
            </div>

            <!-- 5. PROPÓSITO -->
            <section class="space-y-4">
                <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-purple-500 px-2 flex items-center gap-2 italic">
                    <i data-lucide="wine-off" class="w-3 h-3"></i> Propósito
                </h3>
                <div class="glass-card p-6 grid md:grid-cols-3 gap-4">
                    <input type="text" id="set-alcohol-title" onchange="window.savePulseSettings()" class="pulse-input uppercase" placeholder="Título">
                    <input type="date" id="set-alcohol-start" onchange="window.savePulseSettings()" class="pulse-input">
                    <input type="number" id="set-alcohol-target" onchange="window.savePulseSettings()" class="pulse-input" placeholder="Meta Dias">
                </div>
            </section>

            <button onclick="window.savePulseSettings()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-6 rounded-3xl font-black uppercase tracking-[0.4em] text-[10px] shadow-2xl transition-all italic flex items-center justify-center gap-3">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                Sincronização Manual Forçada
            </button>
        </main>
    </div>
</div>

<script type="module" src="./js/app.js"></script>

<script>
    const VEICULOS_DATABASE = {
        Moto: { YAMAHA: { "FAZER 250": 35, "LANDER 250": 32 }, HONDA: { "CB 300F": 33, "CG 160": 42 } },
        Carro: { TOYOTA: { "COROLLA": 12, "HILUX": 10 }, VW: { "GOL": 13, "POLO": 15 } }
    };

    window.updateBrands = () => {
        const tipo = document.getElementById('set-bike-tipo').value;
        const select = document.getElementById('set-bike-montadora');
        select.innerHTML = "";
        Object.keys(VEICULOS_DATABASE[tipo]).forEach(m => select.add(new Option(m, m)));
        window.updateModels();
    };

    window.updateModels = () => {
        const tipo = document.getElementById('set-bike-tipo').value;
        const marca = document.getElementById('set-bike-montadora').value;
        const select = document.getElementById('set-bike-modelo');
        select.innerHTML = "";
        if (VEICULOS_DATABASE[tipo][marca]) {
            Object.keys(VEICULOS_DATABASE[tipo][marca]).forEach(mod => select.add(new Option(mod, mod)));
        }
        window.updateConsumoDefault();
    };

    window.updateConsumoDefault = () => {
        const tipo = document.getElementById('set-bike-tipo').value;
        const marca = document.getElementById('set-bike-montadora').value;
        const modelo = document.getElementById('set-bike-modelo').value;
        const consumo = VEICULOS_DATABASE[tipo][marca][modelo];
        if (consumo) document.getElementById('set-bike-consumo').value = consumo;
    };

    window.autoCalcCaffeine = () => {
        const ml = parseFloat(document.getElementById('set-calib-ml').value) || 0;
        // Referência visual apenas se houver campo de total
    };

    window.toggleAvatarSelector = () => {
        document.getElementById('avatar-selector-wrapper').classList.toggle('hidden');
    };

    window.selectAvatar = (color, icon) => {
        if(window.appState) {
            window.appState.photoURL = `ICON:${color}:${icon}`;
            window.savePulseSettings();
        }
        window.toggleAvatarSelector();
    };

    window.fillAjustesForm = () => {
        if (!window.appState) return;
        document.getElementById('set-user-name').innerText = window.appState.login || "USUÁRIO";
        const v = window.appState.veiculo;
        const p = window.appState.perfil;
        const c = window.appState.calibragem;

        document.getElementById('set-bike-tipo').value = v.tipo || "Moto";
        window.updateBrands();
        if(v.montadora) document.getElementById('set-bike-montadora').value = v.montadora;
        window.updateModels();
        if(v.modelo) document.getElementById('set-bike-modelo').value = v.modelo;
        document.getElementById('set-bike-km').value = v.km || "";
        document.getElementById('set-bike-oleo').value = v.oleo || "";
        document.getElementById('set-bike-consumo').value = v.consumo || "";

        document.getElementById('set-peso').value = p.peso || "";
        document.getElementById('set-altura').value = p.altura || "";
        document.getElementById('set-idade').value = p.idade || "";
        document.getElementById('set-sexo').value = p.sexo || "M";
        document.getElementById('set-estado').value = p.estado || "CE";
        document.getElementById('set-cidade').value = p.cidade || "Fortaleza";

        document.getElementById('set-calib-monster').value = c.monster_mg || 160;
        document.getElementById('set-calib-ml').value = c.coffee_ml || "";

        document.getElementById('set-alcohol-title').value = p.alcoholTitle || "";
        document.getElementById('set-alcohol-start').value = p.alcoholStart || "";
        document.getElementById('set-alcohol-target').value = p.alcoholTarget || 30;
    };

    // Escuta mudanças de sincronização para popular o formulário
    document.addEventListener('DOMContentLoaded', () => {
        const interval = setInterval(() => {
            if(window.appState && window.appState.login !== "USUÁRIO") {
                window.fillAjustesForm();
                clearInterval(interval);
            }
        }, 500);
    });
</script>

</body>
</html>
