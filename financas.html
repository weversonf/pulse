<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PULSE OS - Finanças</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Grid de meses para o seletor */
        .month-picker-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .animate-pop { animation: pop 0.2s ease-out; }
        @keyframes pop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* Ajuste de scroll para a lista recente */
        #fin-extrato-list::-webkit-scrollbar { width: 4px; }
        #fin-extrato-list::-webkit-scrollbar-track { background: transparent; }
        #fin-extrato-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.05); border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <div class="flex min-h-screen relative">
        <!-- 1. Menu Lateral -->
        <div id="sidebar-placeholder"></div>
        
        <!-- 2. Conteúdo Principal -->
        <div id="main-content" class="flex-1 md:ml-64 transition-all pb-safe-bottom">
            <!-- Cabeçalho (Botão de Abastecer via app.js) -->
            <div id="header-placeholder"></div>

            <main class="max-w-6xl mx-auto p-4 md:p-8 space-y-6">

                <!-- Filtro de Período Inteligente (Dropdown) -->
                <div class="relative flex flex-col items-center mb-12">
                    <button onclick="toggleMonthPicker()" class="group flex flex-col items-center gap-1 focus:outline-none">
                        <span class="text-[8px] font-black text-blue-500 uppercase tracking-[0.4em] mb-1 opacity-60 group-hover:opacity-100 transition-all">Selecionar Período</span>
                        <div class="flex items-center gap-3">
                            <h2 id="display-month-year" class="text-xl font-black uppercase tracking-[0.3em] text-white group-hover:text-blue-400 transition-all">CARREGANDO...</h2>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 group-hover:text-blue-400 transition-all"></i>
                        </div>
                    </button>

                    <!-- Painel Seletor -->
                    <div id="month-picker" class="hidden absolute top-16 z-[110] w-72 bg-slate-900 border border-white/10 p-4 rounded-[2rem] shadow-2xl animate-pop">
                        <div class="month-picker-grid mb-4">
                            <button onclick="selectMonth(0)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Jan</button>
                            <button onclick="selectMonth(1)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Fev</button>
                            <button onclick="selectMonth(2)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Mar</button>
                            <button onclick="selectMonth(3)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Abr</button>
                            <button onclick="selectMonth(4)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Mai</button>
                            <button onclick="selectMonth(5)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Jun</button>
                            <button onclick="selectMonth(6)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Jul</button>
                            <button onclick="selectMonth(7)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Ago</button>
                            <button onclick="selectMonth(8)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Set</button>
                            <button onclick="selectMonth(9)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Out</button>
                            <button onclick="selectMonth(10)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Nov</button>
                            <button onclick="selectMonth(11)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Dez</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 pt-4 border-t border-white/5">
                            <button onclick="selectFullYear()" class="py-3 text-[9px] font-black uppercase bg-white/5 hover:bg-white/10 rounded-xl transition-all">2026 Total</button>
                            <button onclick="resetToCurrentMonth()" class="py-3 text-[9px] font-black uppercase bg-blue-600/20 text-blue-400 hover:bg-blue-600 hover:text-white rounded-xl transition-all">Mês Atual</button>
                        </div>
                    </div>
                </div>

                <!-- Resumo Geral - Layout 1+2 Mobile -->
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Cartão Saldo Real: Full no mobile, 1/3 no desktop -->
                    <div class="col-span-2 md:col-span-1 bg-slate-900 border border-white/5 p-6 rounded-2xl flex flex-col justify-between shadow-xl relative overflow-hidden min-h-[150px]">
                        <span class="text-blue-500 text-[9px] font-black uppercase tracking-widest flex items-center gap-2">
                             <i data-lucide="shield-check" class="w-3 h-3"></i> Saldo Real (Efetivado)
                        </span>
                        
                        <!-- Modo Privacidade -->
                        <button onclick="togglePrivacy()" class="absolute top-5 right-5 text-slate-700 hover:text-blue-500 transition-colors z-10">
                            <i data-lucide="eye" id="privacy-icon" class="w-5 h-5"></i>
                        </button>

                        <div class="mt-4">
                            <div class="text-4xl font-black tracking-tighter text-white leading-none">
                                R$ <span id="fin-saldo-atual-pag" class="privacy-mask">0,00</span>
                            </div>
                            <p class="text-[8px] font-black text-slate-600 uppercase tracking-widest mt-2">Saldo Previsto: <span class="text-blue-500/30">R$ <span id="fin-saldo-previsto">0</span></span></p>
                        </div>
                    </div>

                    <!-- Cartão Receitas -->
                    <div class="bg-emerald-950/10 border border-emerald-500/20 p-6 rounded-2xl flex flex-col justify-between min-h-[150px]">
                        <span class="text-emerald-500 text-[9px] font-black uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="trending-up" class="w-3 h-3"></i> Receitas
                        </span>
                        <div class="text-2xl font-black tracking-tighter text-emerald-400 leading-none mt-2">
                            R$ <span id="total-income" class="privacy-mask">0,00</span>
                        </div>
                    </div>

                    <!-- Cartão Despesas -->
                    <div class="bg-red-950/10 border border-red-500/20 p-6 rounded-2xl flex flex-col justify-between min-h-[150px]">
                        <span class="text-red-500 text-[9px] font-black uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="trending-down" class="w-3 h-3"></i> Despesas
                        </span>
                        <div class="text-2xl font-black tracking-tighter text-red-400 leading-none mt-2">
                            R$ <span id="total-expenses" class="privacy-mask">0,00</span>
                        </div>
                    </div>
                </div>

                <!-- Projeção Financeira e Fluxo Recente -->
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <!-- Gráfico com Filtros de Ano e Próximos Meses -->
                    <div class="lg:col-span-3 bg-slate-900 border border-white/5 p-8 rounded-[2rem] shadow-2xl">
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                            <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-slate-500 flex items-center gap-2">
                                <i data-lucide="bar-chart-3" class="w-3 h-3 text-blue-500"></i> Projeção Financeira
                            </h3>
                            <div class="flex bg-slate-950 p-1 rounded-xl border border-white/5 overflow-hidden">
                                <button onclick="window.updateChartRange('2026')" class="range-btn px-4 py-1.5 text-[8px] font-black uppercase bg-blue-600 text-white transition-all" data-range="2026">2026</button>
                                <button onclick="window.updateChartRange(6)" class="range-btn px-4 py-1.5 text-[8px] font-black uppercase transition-all text-slate-500 hover:text-white" data-range="6">+6M</button>
                                <button onclick="window.updateChartRange(12)" class="range-btn px-4 py-1.5 text-[8px] font-black uppercase transition-all text-slate-500 hover:text-white" data-range="12">+12M</button>
                            </div>
                        </div>
                        <div class="h-[320px] relative">
                            <canvas id="financeChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Fluxo Recente do Período -->
                    <div class="lg:col-span-2 bg-slate-900 border border-white/5 p-8 rounded-[2rem] flex flex-col shadow-2xl">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-slate-500 flex items-center gap-2">
                                <i data-lucide="list" class="w-3 h-3 text-blue-500"></i> Fluxo Recente
                            </h3>
                            <button onclick="window.openTab('extrato')" class="text-[8px] font-black uppercase text-blue-500 hover:text-blue-400 transition-colors tracking-widest flex items-center gap-1">
                                Ver todas <i data-lucide="chevron-right" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <div class="space-y-3 overflow-y-auto max-h-[350px] pr-2" id="fin-extrato-list">
                            <!-- Injetado via JS -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Botão Flutuante Novo Lançamento -->
    <button onclick="toggleModal()" class="fixed bottom-24 right-6 md:bottom-8 md:right-8 w-16 h-16 bg-blue-600 hover:bg-blue-500 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 z-[90] transition-all">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </button>

    <!-- Modal de Lançamento -->
    <div id="modal" class="hidden fixed inset-0 bg-slate-950/90 backdrop-blur-xl flex items-center justify-center p-4 z-[100] transition-all">
        <div class="bg-slate-900 border border-white/10 rounded-3xl shadow-2xl w-full max-w-md p-8">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-sm font-black uppercase tracking-[0.2em] text-white">Novo Lançamento</h2>
                <button onclick="toggleModal()" class="text-slate-600 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="fin-desc" placeholder="DESCRIÇÃO" class="pulse-input uppercase">
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="fin-valor" placeholder="VALOR R$" class="pulse-input">
                    <input type="date" id="fin-vencimento" class="pulse-input">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="flex items-center justify-between px-4 py-3 bg-slate-950/50 rounded-xl border border-white/5">
                        <span id="toggle-label" class="text-[9px] font-black uppercase text-emerald-500">Efetivada</span>
                        <label for="status-toggle" class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="status-toggle" class="sr-only" checked onchange="updateStatusValue(this.checked)">
                                <div class="toggle-bg block bg-slate-700 w-10 h-6 rounded-full"></div>
                                <div class="toggle-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                            </div>
                        </label>
                        <input type="hidden" id="fin-status" value="Efetivada">
                    </div>
                    <div class="flex items-center gap-2 px-2 bg-slate-950/50 rounded-xl border border-white/5">
                        <input type="checkbox" id="fin-fixa" class="w-4 h-4 rounded border-white/10 bg-slate-950 text-blue-500">
                        <label for="fin-fixa" class="text-[8px] font-black uppercase text-slate-500">Fixa (12x)</label>
                    </div>
                </div>
                <input type="hidden" id="fin-categoria" value="Geral">
                
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="handleProcess('receita')" class="bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 py-4 rounded-xl font-black uppercase text-[10px] hover:bg-emerald-500 hover:text-white transition-all">Receita</button>
                    <button onclick="handleProcess('despesa')" class="bg-red-500/10 text-red-400 border border-red-500/20 py-4 rounded-xl font-black uppercase text-[10px] hover:bg-red-500 hover:text-white transition-all">Despesa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Motor do Sistema -->
    <script type="module" src="./js/app.js"></script>

    <script>
        let myChart = null;
        window.isPrivate = false;
        window.viewDate = new Date(); // Inicia no mês atual
        window.viewMode = 'month';

        function toggleModal() { document.getElementById('modal').classList.toggle('hidden'); }

        window.toggleMonthPicker = () => {
            const picker = document.getElementById('month-picker');
            picker.classList.toggle('hidden');
        };

        window.selectMonth = (monthIndex) => {
            window.viewMode = 'month';
            window.viewDate.setMonth(monthIndex);
            window.viewDate.setFullYear(2026);
            toggleMonthPicker();
            updateUI();
        };

        window.selectFullYear = () => {
            window.viewMode = 'year';
            window.viewDate.setFullYear(2026);
            toggleMonthPicker();
            updateUI();
        };

        window.resetToCurrentMonth = () => {
            window.viewMode = 'month';
            window.viewDate = new Date();
            toggleMonthPicker();
            updateUI();
        };

        window.togglePrivacy = () => {
            window.isPrivate = !window.isPrivate;
            const icon = document.getElementById('privacy-icon');
            if (icon) icon.setAttribute('data-lucide', window.isPrivate ? 'eye-off' : 'eye');
            if (window.lucide) lucide.createIcons();
            refreshDisplays();
        };

        // Função reativa para atualizar os dados financeiros na tela
        window.refreshDisplays = () => {
            if (!window.appState) return;
            const trans = window.appState.transacoes || [];
            
            let filteredTrans;
            if (window.viewMode === 'month') {
                const filterMonth = window.viewDate.getMonth();
                const filterYear = window.viewDate.getFullYear();
                filteredTrans = trans.filter(t => {
                    if(!t.vencimento) return false;
                    const d = new Date(t.vencimento + "T12:00:00");
                    return d.getMonth() === filterMonth && d.getFullYear() === filterYear;
                });
                document.getElementById('display-month-year').innerText = window.viewDate.toLocaleDateString('pt-BR', { month: 'long' }).toUpperCase();
            } else {
                const filterYear = window.viewDate.getFullYear();
                filteredTrans = trans.filter(t => {
                    if(!t.vencimento) return false;
                    const d = new Date(t.vencimento + "T12:00:00");
                    return d.getFullYear() === filterYear;
                });
                document.getElementById('display-month-year').innerText = "ANO " + filterYear;
            }

            const efektivaj = filteredTrans.filter(t => t.status === 'Efetivada');
            const saldo = efektivaj.reduce((acc, t) => acc + (t.tipo === 'Receita' ? t.valor : -t.valor), 0);
            const receitas = efektivaj.filter(t => t.tipo === 'Receita').reduce((a, b) => a + b.valor, 0);
            const despesas = efektivaj.filter(t => t.tipo === 'Despesa').reduce((a, b) => a + b.valor, 0);
            const previsto = filteredTrans.reduce((acc, t) => acc + (t.tipo === 'Receita' ? t.valor : -t.valor), 0);

            const format = (val) => window.isPrivate ? "%" : val.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            const formatSimple = (val) => window.isPrivate ? "%" : val.toLocaleString('pt-BR', { minimumFractionDigits: 0 });

            document.getElementById('fin-saldo-atual-pag').innerText = format(saldo);
            document.getElementById('total-income').innerText = format(receitas);
            document.getElementById('total-expenses').innerText = format(despesas);
            document.getElementById('fin-saldo-previsto').innerText = formatSimple(previsto);
            
            renderLocalRecent(filteredTrans);
        };

        // Renderiza a lista de fluxo recente com base no filtro
        function renderLocalRecent(transactions) {
            const list = document.getElementById('fin-extrato-list');
            if (!list) return;
            if (transactions.length === 0) {
                list.innerHTML = `<div class="p-8 text-center text-slate-700 text-[10px] font-black uppercase tracking-widest">Sem lançamentos</div>`;
                return;
            }
            const sorted = [...transactions].sort((a, b) => b.id - a.id);
            list.innerHTML = sorted.slice(0, 10).map(t => `
                <div class="flex items-center justify-between p-4 bg-slate-950/30 border border-white/5 rounded-2xl group hover:bg-white/5 transition-all">
                    <div class="flex items-center gap-4">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center ${t.tipo === 'Receita' ? 'bg-emerald-500/10 text-emerald-500' : 'bg-red-500/10 text-red-500'}">
                            <i data-lucide="${t.tipo === 'Receita' ? 'trending-up' : 'trending-down'}" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="text-[10px] font-black text-white uppercase truncate max-w-[150px]">${t.desc}</p>
                            <p class="text-[7px] font-bold text-slate-600 uppercase">${new Date(t.vencimento + "T12:00:00").toLocaleDateString('pt-BR')}</p>
                        </div>
                    </div>
                    <p class="text-xs font-black ${t.tipo === 'Receita' ? 'text-emerald-400' : 'text-red-400'}">
                        ${window.isPrivate ? "%" : "R$ " + t.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                    </p>
                </div>
            `).join('');
            if (window.lucide) lucide.createIcons();
        }

        async function handleProcess(type) {
            if (typeof window.processarLancamento === 'function') {
                await window.processarLancamento(type);
                toggleModal();
                updateUI();
            }
        }

        function updateUI() {
            refreshDisplays();
            initFinanceChart('2026'); 
        }

        function updateStatusValue(isEfetivada) {
            const hiddenInput = document.getElementById('fin-status');
            const label = document.getElementById('toggle-label');
            hiddenInput.value = isEfetivada ? "Efetivada" : "Previsível";
            label.innerText = isEfetivada ? "Efetivada" : "Previsível";
            label.className = `text-[9px] font-black uppercase ${isEfetivada ? 'text-emerald-500' : 'text-slate-500'}`;
        }

        // Lógica do gráfico de projeção com filtros dinâmicos
        window.updateChartRange = (range) => {
            document.querySelectorAll('.range-btn').forEach(btn => {
                const bRange = btn.getAttribute('data-range');
                if (bRange === range.toString()) {
                    btn.classList.add('bg-blue-600', 'text-white');
                    btn.classList.remove('text-slate-500', 'hover:text-white');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('text-slate-500', 'hover:text-white');
                }
            });
            initFinanceChart(range);
        };

        function initFinanceChart(range = '2026') {
            const ctx = document.getElementById('financeChart');
            if (!ctx) return;
            if (myChart) myChart.destroy();
            
            // Busca dados formatados via app.js
            const { labels, balance } = window.getProjectionData(range);

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: balance,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.05)',
                        fill: true, tension: 0.4, borderWidth: 4, pointRadius: 4, pointBackgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.02)' }, ticks: { color: '#475569', font: { size: 9 } } },
                        x: { grid: { display: false }, ticks: { color: '#475569', font: { size: 9, weight: 'bold' } } }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const check = setInterval(() => {
                if (window.appState) { updateUI(); clearInterval(check); }
            }, 500);
            
            // Fecha o seletor de mês ao clicar fora
            document.addEventListener('click', (e) => {
                const picker = document.getElementById('month-picker');
                const btn = document.querySelector('button[onclick="toggleMonthPicker()"]');
                if (picker && !picker.classList.contains('hidden') && !picker.contains(e.target) && !btn.contains(e.target)) {
                    picker.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
