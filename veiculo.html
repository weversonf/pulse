<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PULSE OS - Veículo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .trip-card:hover .compass-btn { transform: scale(1.1) rotate(15deg); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 italic">
    <div class="flex min-h-screen relative">
        <!-- Sidebar Placeholder -->
        <div id="menu-container"></div>

        <div id="main-content" class="flex-1 md:ml-64 transition-all duration-300 pb-safe-bottom">
            
            <!-- Header Placeholder -->
            <div id="header-placeholder"></div>

            <main class="max-w-6xl mx-auto p-4 md:p-8 space-y-6 italic">
                <!-- Status da Máquina -->
                <div class="glass-card p-8 rounded-[1rem] relative overflow-hidden group italic">
                    <div class="absolute top-0 right-0 p-8 opacity-10">
                        <i data-lucide="bike" class="w-24 h-24 text-orange-500"></i>
                    </div>
                    
                    <div class="relative z-10 space-y-6 italic">
                        <div class="flex items-center gap-3 italic">
                            <div class="w-12 h-12 bg-orange-500/20 rounded-2xl flex items-center justify-center text-orange-500">
                                <i data-lucide="gauge" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h2 class="text-xs font-black uppercase tracking-[0.3em] text-orange-500 italic">Odômetro Atual</h2>
                                <p class="text-4xl font-black text-white tracking-tighter italic"><span id="bike-km-display">0</span> <small class="text-xs uppercase text-slate-500">km</small></p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 italic">
                            <div class="bg-slate-950/50 p-6 rounded-3xl border border-white/5 italic">
                                <p class="text-[8px] font-black uppercase text-slate-600 tracking-widest mb-1 italic">Próxima Troca de Óleo</p>
                                <p class="text-xl font-black text-white italic"><span id="bike-oil-display">0</span> <small class="text-[10px] text-slate-600">KM</small></p>
                                <div class="w-full bg-slate-900 h-1.5 rounded-full mt-3 overflow-hidden">
                                    <div id="oil-progress-bar" class="bg-orange-500 h-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="bg-slate-950/50 p-6 rounded-3xl border border-white/5 italic">
                                <p class="text-[8px] font-black uppercase text-slate-600 tracking-widest mb-1 italic">Modelo Registrado</p>
                                <p class="text-xl font-black text-white italic" id="bike-name-display">FAZER 250</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Planejador de Viagem -->
                <div class="glass-card p-8 rounded-[1rem] italic text-left">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-blue-500 flex items-center gap-2 italic">
                            <i data-lucide="compass" class="w-3 h-3"></i> Planejador de Viagem
                        </h3>
                        <span class="text-[8px] font-black text-slate-600 uppercase italic">Origem: Fortaleza / CE</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 italic">
                        <div class="md:col-span-2 space-y-2 italic">
                            <label class="text-[8px] font-black text-slate-600 uppercase tracking-widest px-2 italic text-left block">Destino (Cidade/Lugar)</label>
                            <input type="text" id="trip-dest" class="pulse-input w-full uppercase" placeholder="EX: JERICOACOARA">
                        </div>
                        <div class="space-y-2 italic">
                            <label class="text-[8px] font-black text-slate-600 uppercase tracking-widest px-2 italic text-left block">Distância (KM)</label>
                            <input type="number" id="trip-km" oninput="window.updateTripCalc()" class="pulse-input w-full" placeholder="0">
                        </div>
                        <div class="space-y-2 italic">
                            <label class="text-[8px] font-black text-slate-600 uppercase tracking-widest px-2 italic text-left block">Data da Viagem</label>
                            <input type="date" id="trip-date" class="pulse-input w-full uppercase">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6 italic items-end">
                        <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5 text-center">
                            <p class="text-[8px] font-black uppercase text-slate-600 tracking-widest mb-1 italic">Consumo Configurado</p>
                            <p class="text-lg font-black text-white italic"><span id="trip-consumo-val-display">29</span> <small class="text-[10px] text-slate-600 uppercase">KM/L</small></p>
                        </div>
                        <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5 text-center">
                            <p class="text-[8px] font-black uppercase text-slate-600 tracking-widest mb-1 italic">Combustível</p>
                            <p class="text-lg font-black text-blue-400 italic"><span id="trip-litros-val">0.0</span> <small class="text-[10px] uppercase">L</small></p>
                        </div>
                        <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5 text-center">
                            <p class="text-[8px] font-black uppercase text-slate-600 tracking-widest mb-1 italic">Custo Estimado</p>
                            <p class="text-lg font-black text-emerald-400 italic">R$ <span id="trip-custo-val">0</span></p>
                        </div>
                        <button onclick="window.planTrip()" class="bg-blue-600 hover:bg-blue-500 text-white h-[58px] rounded-2xl font-black uppercase tracking-widest text-[10px] transition-all active:scale-95 shadow-lg shadow-blue-900/20 italic">
                            Planejar Viagem
                        </button>
                    </div>
                </div>

                <!-- Próximas Aventuras -->
                <div class="space-y-4 italic text-left">
                    <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-slate-500 px-6 italic">Próximas Aventuras</h3>
                    <div id="upcoming-trips-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 italic">
                        <!-- Injetado pelo app.js -->
                    </div>
                </div>

                <!-- Histórico -->
                <div class="space-y-4 italic text-left">
                    <div class="flex items-center justify-between px-6 italic">
                        <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-slate-500 italic">Linha do Tempo da Máquina</h3>
                        <button onclick="window.openTab('extrato')" class="text-[8px] font-black text-blue-500 uppercase tracking-widest italic hover:underline">Ver Todos</button>
                    </div>
                    <div id="bike-history-list" class="space-y-2 italic pb-20">
                        <!-- Injetado pelo app.js -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Botão Flutuante (Lançamento Veicular) -->
    <button onclick="toggleBikeModal()" class="fixed bottom-24 right-6 md:bottom-8 md:right-8 w-16 h-16 bg-orange-600 hover:bg-orange-500 text-white rounded-full flex items-center justify-center shadow-lg shadow-orange-900/20 active:scale-90 z-[90] italic transition-all">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </button>

    <!-- Modal de Lançamento Veicular -->
    <div id="bike-modal" class="hidden fixed inset-0 bg-slate-950/90 backdrop-blur-xl flex items-center justify-center p-4 z-[100] transition-all italic">
        <div class="bg-slate-900 border border-white/5 rounded-[1rem] shadow-2xl w-full max-w-md p-8 italic max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 italic">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-orange-500/20 rounded-xl flex items-center justify-center text-orange-500">
                        <i data-lucide="bike" class="w-5 h-5"></i>
                    </div>
                    <h2 class="text-[12px] font-black uppercase tracking-[0.2em] text-white italic">Log da Máquina</h2>
                </div>
                <button onclick="toggleBikeModal()" class="text-slate-600 hover:text-white italic transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4 italic text-left">
                <div class="space-y-1">
                    <label class="text-[8px] font-black uppercase tracking-widest text-slate-500 px-2 italic block">Ocorrência / Descrição</label>
                    <input type="text" id="bike-log-desc" placeholder="EX: POSTO IPIRANGA - TANQUE CHEIO" class="pulse-input w-full uppercase">
                </div>

                <div class="grid grid-cols-2 gap-3 italic">
                    <div class="space-y-1">
                        <label class="text-[8px] font-black uppercase tracking-widest text-slate-500 px-2 italic block">KM Atual</label>
                        <input type="number" id="bike-log-km" placeholder="0" class="pulse-input w-full">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[8px] font-black uppercase tracking-widest text-slate-500 px-2 italic block">Tipo de Registro</label>
                        <select id="bike-log-tipo" onchange="toggleFuelFields()" class="pulse-input w-full uppercase cursor-pointer">
                            <option value="Abastecimento" selected>Abastecimento</option>
                            <option value="Manutenção">Manutenção</option>
                            <option value="Limpeza">Limpeza / Estética</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                </div>

                <!-- Campos Específicos de Abastecimento -->
                <div id="fuel-fields" class="space-y-4 animate-in fade-in slide-in-from-top-2 duration-300">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[8px] font-black uppercase tracking-widest text-slate-500 px-2 italic block">Preço do Litro (R$)</label>
                            <input type="number" id="bike-fuel-price" step="0.01" placeholder="0,00" oninput="recalcFuel('price')" class="pulse-input w-full">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[8px] font-black uppercase tracking-widest text-slate-500 px-2 italic block">Quantidade (L)</label>
                            <input type="number" id="bike-fuel-liters" step="0.01" placeholder="0,00" oninput="recalcFuel('liters')" class="pulse-input w-full">
                        </div>
                    </div>
                </div>

                <!-- Valor Total (Sempre Aberto e Integrado ao Cálculo) -->
                <div class="space-y-1">
                    <label class="text-[8px] font-black uppercase tracking-widest text-orange-500 px-2 italic block">Valor Total (R$)</label>
                    <input type="number" id="bike-log-valor" step="0.01" placeholder="0,00" oninput="recalcFuel('total')" class="pulse-input w-full border-orange-500/20 text-orange-400">
                </div>

                <button onclick="handleBikeSave()" class="w-full bg-orange-600 hover:bg-orange-500 text-white py-5 rounded-3xl font-black uppercase tracking-[0.2em] text-[10px] mt-4 shadow-xl shadow-orange-900/10 transition-all active:scale-95 italic">
                    Confirmar Registro
                </button>
            </div>
        </div>
    </div>
    
<script type="module" src="./js/app.js"></script>
    <script>
        // Função para abrir/fechar o modal
        function toggleBikeModal() {
            const modal = document.getElementById('bike-modal');
            if (!modal) return;
            
            const isHidden = modal.classList.contains('hidden');
            if(isHidden) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                document.getElementById('bike-log-km').value = (window.appState && window.appState.veiculo) ? window.appState.veiculo.km : 0;
                document.getElementById('bike-log-tipo').value = "Abastecimento";
                toggleFuelFields();
                document.getElementById('bike-log-desc').focus();
            } else {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        // Mostra ou esconde campos de combustível
        function toggleFuelFields() {
            const tipo = document.getElementById('bike-log-tipo').value;
            const fuelFields = document.getElementById('fuel-fields');
            if (fuelFields) {
                if (tipo === 'Abastecimento') fuelFields.classList.remove('hidden');
                else fuelFields.classList.add('hidden');
            }
        }

        // Lógica de Recálculo Dinâmico Multi-direcional
        function recalcFuel(changedField) {
            const tipo = document.getElementById('bike-log-tipo').value;
            if (tipo !== 'Abastecimento') return;

            const priceEl = document.getElementById('bike-fuel-price');
            const litersEl = document.getElementById('bike-fuel-liters');
            const totalEl = document.getElementById('bike-log-valor');

            const price = parseFloat(priceEl.value) || 0;
            const liters = parseFloat(litersEl.value) || 0;
            const total = parseFloat(totalEl.value) || 0;

            if (changedField === 'total') {
                if (price > 0) litersEl.value = (total / price).toFixed(2);
                else if (liters > 0) priceEl.value = (total / liters).toFixed(2);
            } 
            else if (changedField === 'price') {
                if (total > 0) litersEl.value = (total / price).toFixed(2);
                else if (liters > 0) totalEl.value = (price * liters).toFixed(2);
            }
            else if (changedField === 'liters') {
                if (total > 0) priceEl.value = (total / liters).toFixed(2);
                else if (price > 0) totalEl.value = (price * liters).toFixed(2);
            }
        }

        // Wrapper para salvar e garantir o fecho
        async function handleBikeSave() {
            const desc = document.getElementById('bike-log-desc').value.trim();
            const km = document.getElementById('bike-log-km').value;
            const valor = document.getElementById('bike-log-valor').value;
            
            if (!desc || !km || !valor) return;

            if (window.saveBikeEntry) {
                // Executa o salvamento no app.js
                await window.saveBikeEntry();
                
                // Fecha o modal de forma explícita
                const modal = document.getElementById('bike-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
                
                // Limpeza dos campos
                document.getElementById('bike-log-desc').value = "";
                document.getElementById('bike-fuel-price').value = "";
                document.getElementById('bike-fuel-liters').value = "";
                document.getElementById('bike-log-valor').value = "";
            }
        }

        window.updateTripCalc = () => {
            const km = parseFloat(document.getElementById('trip-km').value) || 0;
            const consumo = (window.appState && window.appState.veiculo && window.appState.veiculo.consumo) ? window.appState.veiculo.consumo : 29;
            const precoLitro = 5.97; 

            const litros = km / consumo;
            const custo = litros * precoLitro;

            document.getElementById('trip-litros-val').innerText = litros.toFixed(1);
            document.getElementById('trip-custo-val').innerText = Math.round(custo);
            
            const displayConsumo = document.getElementById('trip-consumo-val-display');
            if(displayConsumo) displayConsumo.innerText = consumo;
        };

        window.planTrip = () => {
            const dest = document.getElementById('trip-dest').value.trim();
            const km = document.getElementById('trip-km').value;
            const date = document.getElementById('trip-date').value;
            const custo = document.getElementById('trip-custo-val').innerText;

            if (!dest || !km || !date) return;

            const novaViagem = {
                id: Date.now(),
                destino: dest.toUpperCase(),
                distancia: km,
                data: date,
                custo: custo
            };

            if (!window.appState.veiculo.viagens) window.appState.veiculo.viagens = [];
            window.appState.veiculo.viagens.push(novaViagem);
            
            document.getElementById('trip-dest').value = '';
            document.getElementById('trip-km').value = '';
            document.getElementById('trip-date').value = '';
            
            if (window.saveLocalData) window.saveLocalData();
            renderTrips();
        };

        window.renderTrips = () => {
            const list = document.getElementById('upcoming-trips-list');
            if (!list || !window.appState.veiculo || !window.appState.veiculo.viagens) return;

            list.innerHTML = window.appState.veiculo.viagens.map(v => `
                <div class="glass-card p-6 flex items-center justify-between trip-card border-blue-500/10 hover:border-blue-500/30 transition-all italic">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-500/10 rounded-2xl flex items-center justify-center text-blue-400">
                            <i data-lucide="map-pin"></i>
                        </div>
                        <div>
                            <h4 class="text-sm font-black text-white uppercase italic text-left">${v.destino}</h4>
                            <p class="text-[8px] font-bold text-slate-500 uppercase tracking-widest mt-1 italic text-left">
                                ${new Date(v.data + "T12:00:00").toLocaleDateString('pt-BR')} • ${v.distancia} KM • R$ ${v.custo}
                            </p>
                        </div>
                    </div>
                    <button onclick="window.openRoute('${v.destino}')" class="compass-btn w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white shadow-lg transition-all active:scale-90">
                        <i data-lucide="compass"></i>
                    </button>
                </div>
            `).join('');

            if (window.lucide) lucide.createIcons();
        };

        window.openRoute = (destino) => {
            const url = `https://www.google.com/maps/dir/Fortaleza,+CE/${destino}`;
            window.open(url, '_blank');
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (window.lucide) lucide.createIcons();
            
            if (window.appState && window.appState.veiculo) {
                const kmAtual = window.appState.veiculo.km || 0;
                const kmOleo = window.appState.veiculo.oleo || 0;
                const diff = Math.max(0, kmOleo - kmAtual);
                const pct = Math.max(0, Math.min(100, (diff / 3000) * 100)); 
                const bar = document.getElementById('oil-progress-bar');
                if(bar) bar.style.width = (100 - pct) + '%';

                const consumo = window.appState.veiculo.consumo || 29;
                const displayConsumo = document.getElementById('trip-consumo-val-display');
                if(displayConsumo) displayConsumo.innerText = consumo;
            }

            renderTrips();
        });
    </script>
</body>
</html>


