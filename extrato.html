<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PULSE OS - Extrato</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Grid de meses */
        .month-picker-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .animate-pop { animation: pop 0.2s ease-out; }
        @keyframes pop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <div class="flex min-h-screen relative">
        <!-- 1. Placeholder da Barra Lateral -->
        <div id="sidebar-placeholder"></div>

        <!-- 2. Container de Conteúdo -->
        <div id="main-content" class="flex-1 md:ml-64 transition-all pb-safe-bottom">
            
            <!-- 3. Placeholder do Cabeçalho -->
            <div id="header-placeholder"></div>

            <main class="max-w-6xl mx-auto p-4 md:p-8 space-y-6">
                
                <!-- Filtro de Período Inteligente -->
                <div class="relative flex flex-col items-center mb-12">
                    <button onclick="toggleMonthPicker()" class="group flex flex-col items-center gap-1 focus:outline-none">
                        <span class="text-[8px] font-black text-blue-500 uppercase tracking-[0.4em] mb-1 opacity-60 group-hover:opacity-100 transition-all">Filtrar Período</span>
                        <div class="flex items-center gap-3">
                            <h2 id="extrato-month-display" class="text-xl font-black uppercase tracking-[0.3em] text-white group-hover:text-blue-400 transition-all">CARREGANDO...</h2>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 group-hover:text-blue-400 transition-all"></i>
                        </div>
                    </button>

                    <!-- Painel Seletor (Dropdown) -->
                    <div id="month-picker" class="hidden absolute top-16 z-[110] w-72 bg-slate-900 border border-white/10 p-4 rounded-[2rem] shadow-2xl animate-pop">
                        <div class="month-picker-grid mb-4">
                            <button onclick="selectMonth(0)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Jan</button>
                            <button onclick="selectMonth(1)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Fev</button>
                            <button onclick="selectMonth(2)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Mar</button>
                            <button onclick="selectMonth(3)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Abr</button>
                            <button onclick="selectMonth(4)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Mai</button>
                            <button onclick="selectMonth(5)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Jun</button>
                            <button onclick="selectMonth(6)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Jul</button>
                            <button onclick="selectMonth(7)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Ago</button>
                            <button onclick="selectMonth(8)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Set</button>
                            <button onclick="selectMonth(9)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Out</button>
                            <button onclick="selectMonth(10)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Nov</button>
                            <button onclick="selectMonth(11)" class="p-3 text-[10px] font-black uppercase hover:bg-white/5 rounded-xl transition-all">Dez</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 pt-4 border-t border-white/5">
                            <button onclick="selectFullYear()" class="py-3 text-[9px] font-black uppercase bg-white/5 hover:bg-white/10 rounded-xl transition-all">2026 Total</button>
                            <button onclick="resetToCurrentMonth()" class="py-3 text-[9px] font-black uppercase bg-blue-600/20 text-blue-400 hover:bg-blue-600 hover:text-white rounded-xl transition-all">Mês Atual</button>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-[10px] font-black uppercase tracking-[0.4em] text-blue-500 mb-2">Money Hub</h2>
                        <h1 class="text-4xl font-black tracking-tighter text-white uppercase leading-none">Histórico Completo</h1>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.openTab('financas')" class="bg-white/5 hover:bg-white/10 p-3 rounded-xl transition-all">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- Filtros e Busca -->
                <div class="glass-card p-6 flex flex-col md:flex-row gap-4 items-center">
                    <div class="relative flex-1 w-full">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-600"></i>
                        <input type="text" id="extrato-search" onkeyup="window.filterExtrato()" placeholder="BUSCAR POR DESCRIÇÃO..." class="pulse-input w-full pl-12">
                    </div>
                    <select id="filter-type" onchange="window.filterExtrato()" class="pulse-input md:w-48 cursor-pointer uppercase">
                        <option value="todos">TUDO</option>
                        <option value="Receita">RECEITAS</option>
                        <option value="Despesa">DESPESAS</option>
                    </select>
                </div>

                <!-- Lista de Transações -->
                <div class="glass-card overflow-hidden shadow-2xl">
                    <div class="p-6 border-b border-white/5 bg-white/2">
                        <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-500">Lista de Lançamentos Sincronizada</h3>
                    </div>
                    <div id="extrato-full-list" class="divide-y divide-white/5">
                        <div class="p-12 text-center text-[10px] font-black uppercase text-slate-700 animate-pulse">
                            Sincronizando com Makro Cloud...
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- CARREGAMENTO COMO MÓDULO -->
    <script type="module" src="./js/app.js"></script>

    <script>
        // CONFIGURAÇÃO INICIAL: Agora o app.js garante a inicialização, mas mantemos o controle local da data
        window.extratoDate = new Date(); 
        window.extratoMode = 'month'; 

        function toggleMonthPicker() {
            const picker = document.getElementById('month-picker');
            picker.classList.toggle('hidden');
        }

        window.selectMonth = (monthIndex) => {
            window.extratoMode = 'month';
            window.extratoDate.setMonth(monthIndex);
            window.extratoDate.setFullYear(2026);
            toggleMonthPicker();
            window.filterExtrato();
        };

        window.selectFullYear = () => {
            window.extratoMode = 'year';
            window.extratoDate.setFullYear(2026);
            toggleMonthPicker();
            window.filterExtrato();
        };

        window.resetToCurrentMonth = () => {
            window.extratoMode = 'month';
            window.extratoDate = new Date();
            toggleMonthPicker();
            window.filterExtrato();
        };

        window.filterExtrato = () => {
            const query = document.getElementById('extrato-search').value.toLowerCase();
            const type = document.getElementById('filter-type').value;
            window.renderFullExtrato(query, type);
        };

        window.renderFullExtrato = (query = "", typeFilter = "todos") => {
            const list = document.getElementById('extrato-full-list');
            const display = document.getElementById('extrato-month-display');
            
            if (!list || !window.appState || !window.appState.transacoes) return;

            // Renderiza o título do período no topo
            if (window.extratoMode === 'month') {
                display.innerText = window.extratoDate.toLocaleDateString('pt-BR', { month: 'long' }).toUpperCase();
            } else {
                display.innerText = "ANO " + window.extratoDate.getFullYear();
            }

            const filterMonth = window.extratoDate.getMonth();
            const filterYear = window.extratoDate.getFullYear();

            const filtered = window.appState.transacoes.filter(t => {
                if(!t.vencimento) return false;
                const d = new Date(t.vencimento + "T12:00:00");
                
                const matchesDate = window.extratoMode === 'month' ? 
                    (d.getMonth() === filterMonth && d.getFullYear() === filterYear) :
                    (d.getFullYear() === filterYear);
                
                const matchesDesc = (t.desc || "").toLowerCase().includes(query);
                const matchesType = typeFilter === "todos" || t.tipo === typeFilter;
                
                return matchesDate && matchesDesc && matchesType;
            }).sort((a, b) => b.id - a.id);

            if (filtered.length === 0) {
                list.innerHTML = `<div class="p-12 text-center text-[10px] font-black uppercase text-slate-700 tracking-widest">Nenhum registro encontrado para este período</div>`;
                return;
            }

            list.innerHTML = filtered.map(t => `
                <div class="p-6 flex items-center justify-between hover:bg-white/2 transition-all group">
                    <div class="flex items-center gap-6">
                        <div class="w-12 h-12 rounded-2xl ${t.tipo === 'Receita' ? 'bg-emerald-500/10 text-emerald-500' : 'bg-red-500/10 text-red-500'} flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                            <i data-lucide="${t.tipo === 'Receita' ? 'trending-up' : 'trending-down'}" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <p class="text-sm font-black text-white uppercase tracking-tighter">${t.desc || 'Sem descrição'}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[8px] font-black text-slate-600 uppercase tracking-widest">${t.data}</span>
                                <span class="w-1 h-1 bg-slate-800 rounded-full"></span>
                                <span class="text-[8px] font-black text-blue-500/60 uppercase tracking-widest">${t.cat || 'Geral'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-black ${t.tipo === 'Receita' ? 'text-emerald-400' : 'text-red-400'} tracking-tighter">
                            ${t.tipo === 'Receita' ? '+' : '-'} R$ ${parseFloat(t.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                        </p>
                        <p class="text-[8px] font-bold text-slate-600 uppercase mt-1 flex items-center justify-end gap-1">
                            <i data-lucide="${t.status === 'Efetivada' ? 'shield-check' : 'clock'}" class="w-2 h-2"></i>
                            ${t.status}
                        </p>
                    </div>
                </div>
            `).join('');

            if (window.lucide) lucide.createIcons();
        };

        document.addEventListener('DOMContentLoaded', () => {
            const checkSync = setInterval(() => {
                if (window.appState && window.appState.transacoes) {
                    window.renderFullExtrato();
                    clearInterval(checkSync);
                }
            }, 500);

            document.addEventListener('click', (e) => {
                const picker = document.getElementById('month-picker');
                const btn = document.querySelector('button[onclick="toggleMonthPicker()"]');
                if (picker && !picker.classList.contains('hidden') && !picker.contains(e.target) && !btn.contains(e.target)) {
                    picker.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
